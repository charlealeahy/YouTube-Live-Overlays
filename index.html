<!doctype html>
<html lang="en">
<head>
<script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>
<meta charset="utf-8" />
<meta name="viewport" content="width=440, initial-scale=1" />
<title>ISS Overlay 440×240</title>
<style>
:root{--bg:#0b0f14;--panel:#1b2229;--panel2:#11161b;--stroke:#3b4248;
--text:#e6eef5;--muted:#9aa7b3;--live:#b11313}
*{box-sizing:border-box;font-family:"Segoe UI",Roboto,Arial,sans-serif}
html,body{margin:0;height:100%}
/* DEMO PAGE BACKDROP (so GH Pages isn’t white) */
body{display:grid;place-items:center;background:#0a0f15}
/* WIDGET */
.wrap{width:440px;height:240px;color:var(--text)}
.title{height:84px;display:flex;align-items:center;gap:12px;padding:0 14px;
background:linear-gradient(#161c22,#0d1216);border:1px solid #2c3338;border-bottom:none;
border-top-left-radius:10px;border-top-right-radius:10px}
.flag{width:44px;height:28px;border-radius:4px;overflow:hidden;display:flex;align-items:center;justify-content:center;background:#2a3440;border:1px solid #45515c}
.flag img{width:100%;height:100%;object-fit:cover;display:block}
.ocean-dot{width:14px;height:14px;border-radius:50%;background:#62b0ff;box-shadow:0 0 0 3px #14334d inset}
.name{font-weight:600;font-size:36px;letter-spacing:.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
.row{height:156px;display:grid;grid-template-columns:128px 12px 1fr;background:var(--panel2);
border:1px solid #2c3338;border-top:none;border-bottom-left-radius:10px;border-bottom-right-radius:10px;padding:12px}
.thumb{width:128px;height:96px;border-radius:6px;overflow:hidden;background:#4f5c64;border:1px solid #9aa6b1;position:relative}
.thumb img{width:100%;height:100%;object-fit:cover;display:block}
.live{position:absolute;left:0;bottom:-26px;transform:translateY(-6px);background:var(--live);color:#fff;
font-weight:800;font-size:14px;padding:5px 10px;border-radius:6px;box-shadow:0 2px 8px #0007}
.credit{position:absolute;right:6px;bottom:4px;font-size:10px;color:#c9d6e4;background:#0009;padding:2px 6px;border-radius:4px}
.panel{background:var(--panel);border:1px solid var(--stroke);border-radius:6px;padding:10px 12px;display:grid;grid-template-rows:auto auto auto auto;gap:6px}
.now{font-weight:800;font-size:20px;color:#cfd8df;margin-bottom:2px}
.line{display:flex;gap:12px;color:var(--muted);font-size:18px}
.line b{color:var(--text);font-weight:600}
.sp{width:12px}
</style>
</head>
<body>
<div class="wrap" id="widget">
  <div class="title">
    <div class="flag" id="flagBox"><div class="ocean-dot" id="oceanDot" hidden></div></div>
    <div class="name" id="placeName">—</div>
  </div>
  <div class="row">
    <div class="thumb">
      <img id="thumbImg" alt="Location image"/>
      <div class="credit" id="credit" hidden></div>
      <div class="live" id="liveBadge">LIVE NOW</div>
    </div>
    <div class="sp"></div>
    <div class="panel">
      <div class="now" id="nowText">Now: Sunset (1 of 16)</div>
      <div class="line"><span id="date">—</span><b id="time">— UTC</b></div>
      <div class="line"><span id="speed">— km/s</span><b id="elev">Elev: — km</b></div>
      <div class="line"><span id="coords">—</span></div>
    </div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const UNSPLASH_ACCESS_KEY = "b-noVjyVf5IBRDh5VaZP6HR0apDT8IwonBdoF_TBZk4";     // <— put your key
const CACHE_MIN = 30;
const DEFAULT_IMG = "assets/locations/pacific-ocean.jpg";
const FLAGS = {
  "mongolia":"assets/flags/mn.svg","vietnam":"assets/flags/vn.svg",
  "united states":"assets/flags/us.svg","thailand":"assets/flags/th.svg",
  "russian federation":"assets/flags/ru.svg"
};

const el = {
  flagBox:document.getElementById('flagBox'),
  oceanDot:document.getElementById('oceanDot'),
  placeName:document.getElementById('placeName'),
  thumb:document.getElementById('thumbImg'),
  credit:document.getElementById('credit'),
  live:document.getElementById('liveBadge'),
  nowText:document.getElementById('nowText'),
  date:document.getElementById('date'),
  time:document.getElementById('time'),
  speed:document.getElementById('speed'),
  elev:document.getElementById('elev'),
  coords:document.getElementById('coords'),
};
const norm = s => (s||"").toLowerCase().trim();

/* ---------- LIVE DATA ---------- */
// 1) ISS position, velocity, altitude (CORS-enabled)
async function getISS(){
  const u = new URL("https://api.wheretheiss.at/v1/satellites/25544");
  u.searchParams.set("_", Date.now()); // bust caches
  const r = await fetch(u, {cache:"no-store"});
  if(!r.ok) throw new Error("ISS API "+r.status);
  const j = await r.json();
  return {
    lat: j.latitude,
    lon: j.longitude,
    speed_kms: j.velocity/1000,         // m/s → km/s (api returns m/s? wheretheiss returns km/h? If so: j.velocity/3600)
    elev_km: j.altitude,                // already km
    utc: new Date(j.timestamp*1000)
  };
}
// If wheretheiss velocity is km/h, use: speed_kms: j.velocity/3600

// 2) Reverse geocode to Country or Ocean
async function getPlace(lat, lon){
  // Try BigDataCloud (fast, free)
  try{
    const u1 = new URL("https://api.bigdatacloud.net/data/reverse-geocode-client");
    u1.searchParams.set("latitude", lat);
    u1.searchParams.set("longitude", lon);
    u1.searchParams.set("localityLanguage","en");
    const r1 = await fetch(u1, {cache:"no-store"});
    if(r1.ok){
      const j = await r1.json();
      if(j.countryName) return {label: j.countryName, isOcean:false};
    }
  }catch{}

  // Fallback to Nominatim — often returns ocean/sea names
  try{
    const u2 = new URL("https://nominatim.openstreetmap.org/reverse");
    u2.searchParams.set("format","jsonv2");
    u2.searchParams.set("zoom","3");
    u2.searchParams.set("lat", lat);
    u2.searchParams.set("lon", lon);
    u2.searchParams.set("accept-language","en");
    const r2 = await fetch(u2, {cache:"no-store", headers:{'User-Agent':'ISS-Overlay Demo'}});
    if(r2.ok){
      const j2 = await r2.json();
      const name = j2?.name || j2?.address?.country || "Earth";
      const isOcean = /ocean|sea|gulf|bay|channel|strait/i.test(name) && !j2?.address?.country;
      return {label: name, isOcean};
    }
  }catch{}

  return {label:"Earth", isOcean:false};
}

// 3) Day/Night/Sunrise/Sunset using SunCalc
function sunState(lat, lon, date){
  const times = SunCalc.getTimes(date, lat, lon);
  const now = date.getTime();
  const sunrise = times.sunrise.getTime();
  const sunset  = times.sunset.getTime();
  const dawn    = times.sunriseEnd.getTime();
  const dusk    = times.sunsetStart.getTime();

  if (now >= sunrise && now <= dawn)   return "sunrise";
  if (now >= dusk && now <= sunset)    return "sunset";
  if (now > dawn && now < dusk)        return "day";
  return "night";
}

/* ---------- Unsplash with caching ---------- */
function ck(q){return "unsplash:"+q;}
function cget(q){try{const r=localStorage.getItem(ck(q)); if(!r) return null; const o=JSON.parse(r); if(Date.now()-o.t> CACHE_MIN*60*1000) return null; return o.v;}catch{return null}}
function cset(q,v){try{localStorage.setItem(ck(q),JSON.stringify({t:Date.now(),v}))}catch{}}
async function fetchUnsplash(query){
  if(!UNSPLASH_ACCESS_KEY || UNSPLASH_ACCESS_KEY==="YOUR_UNSPLASH_ACCESS_KEY") throw new Error("Unsplash key missing");
  const q=query+" landscape";
  const cached=cget(q); if(cached) return cached;
  const url=new URL("https://api.unsplash.com/search/photos");
  url.searchParams.set("query",q);
  url.searchParams.set("orientation","landscape");
  url.searchParams.set("content_filter","high");
  url.searchParams.set("per_page","1");
  url.searchParams.set("client_id",UNSPLASH_ACCESS_KEY);
  const res=await fetch(url,{cache:"no-store"});
  if(!res.ok) throw new Error("Unsplash "+res.status);
  const j=await res.json();
  if(!j.results?.length) throw new Error("No results");
  const p=j.results[0];
  const photoUrl=p.urls.raw+"&w=256&h=192&fit=crop&auto=format";
  const credit=`${p.user.name} / Unsplash`;
  const out={url:photoUrl,credit};
  cset(q,out);
  return out;
}

/* ---------- UI helpers ---------- */
function setFlag(place, isOcean){
  el.flagBox.innerHTML="";
  if(isOcean){
    el.oceanDot.hidden=false; el.flagBox.appendChild(el.oceanDot);
  }else{
    el.oceanDot.hidden=true;
    const src=FLAGS[norm(place)];
    if(src){const img=new Image(); img.src=src; img.alt=place+" flag"; el.flagBox.appendChild(img);}
  }
}
function dtParts(d){
  const date=d.toLocaleDateString("en-US",{month:"short",day:"2-digit",year:"numeric"});
  const time=d.toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:false,timeZone:"UTC"})+" UTC";
  return {date,time};
}

/* ---------- RENDER LOOP ---------- */
async function render(){
  try{
    const iss = await getISS();
    const place = await getPlace(iss.lat, iss.lon);
    const state = sunState(iss.lat, iss.lon, iss.utc);

    el.placeName.textContent = place.label;
    setFlag(place.label, place.isOcean);

    const {date,time} = dtParts(iss.utc);
    el.date.textContent = date;
    el.time.textContent = time;
    el.speed.textContent = `${iss.speed_kms.toFixed(4)} km/s`;
    el.elev.textContent  = `Elev: ${iss.elev_km.toFixed(1)} km`;
    el.coords.textContent = `${Math.abs(iss.lat).toFixed(2)} °${iss.lat>=0?"N":"S"}, ${Math.abs(iss.lon).toFixed(2)} °${iss.lon>=0?"E":"W"}`;
    el.live.style.display = "inline-block"; // wire to your stream health when ready
    el.nowText.textContent = `Now: ${state[0].toUpperCase()+state.slice(1)} (1 of 16)`;

    try{
      const {url,credit} = await fetchUnsplash(place.label);
      el.thumb.src = url; el.credit.textContent = credit; el.credit.hidden = false;
    }catch{
      el.thumb.src = DEFAULT_IMG; el.credit.hidden = true;
    }
  }catch(e){
    console.error(e);
  }
}

// initial + interval
render();
setInterval(render, 15000); // update every 15s
</script>
</body>
</html>
