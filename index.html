<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ISS Overlay</title>
<style>
  :root{
    --bg:#0b1419;
    --panel:#0d151b;
    --panel2:#101b22;
    --ink:#e9f2fb;
    --muted:#a9bac8;
    --shadow:0 30px 60px rgba(0,0,0,.45);
    --radius:18px;
  }
  *{box-sizing:border-box}
  html,body{
    margin:0;padding:24px;background:#0b1419;color:var(--ink);
    font:500 16px/1.4 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial
  }
  #widget{
    width:620px;max-width:100%;
    background:linear-gradient(180deg,#0c141a,#0b1319);
    border-radius:var(--radius);
    padding:22px 22px 20px;
    box-shadow:var(--shadow);
    border:1px solid rgba(255,255,255,.04);
  }
  .title{
    background:radial-gradient(80% 120% at 50% 0%,#101b22,#0c141a 70%);
    border-radius:14px;
    padding:14px 18px;
    text-align:center;
    font-weight:800;
    letter-spacing:.2px;
    font-size:28px;
    color:#eaf3ff;
    border:1px solid rgba(255,255,255,.04);
  }
  .row{
    display:grid;grid-template-columns:128px 1fr;gap:18px;margin-top:16px;
  }
  /* Left column (image + LIVE) */
  .left{
    display:flex;flex-direction:column;align-items:center;justify-content:flex-start;
    background:var(--panel);
    border-radius:14px;border:1px solid rgba(255,255,255,.05);
    padding:14px;
  }
  .flagbox{width:96px;height:72px;border-radius:10px;overflow:hidden;
    display:flex;align-items:center;justify-content:center;background:#0a1014}
  .flagbox img{width:100%;height:100%;object-fit:cover;display:block}
  .live{
    margin-top:14px;background:linear-gradient(180deg,#ff5a50,#e0433a);
    color:#fff;font-weight:800;letter-spacing:.5px;padding:8px 18px;border-radius:12px;
    border:1px solid rgba(0,0,0,.25);
    box-shadow:inset 0 1px 0 rgba(255,255,255,.25),0 4px 12px rgba(224,67,58,.35)
  }
  .live::before{content:"●";margin-right:8px;color:#fff;text-shadow:0 0 8px rgba(255,255,255,.6)}
  /* Right panel (info) — matches left column height so text never drops below LIVE */
  .info{
    background:var(--panel2);border-radius:14px;border:1px solid rgba(255,255,255,.05);
    padding:16px 18px;display:flex;flex-direction:column;justify-content:center;
    min-height:calc(72px + 14px + 38px);
  }
  .kv{display:grid;grid-template-columns:110px 1fr;gap:6px 14px;align-content:center}
  .k{color:var(--muted);font-weight:700}
  .v{color:var(--ink);font-weight:800}
  .unit{color:var(--muted);font-weight:700;margin-left:6px}
  @media (max-width:560px){
    #widget{padding:16px}
    .title{font-size:22px;padding:12px 14px}
    .row{grid-template-columns:110px 1fr;gap:12px}
    .flagbox{width:86px;height:64px}
    .live{padding:7px 14px}
    .kv{grid-template-columns:96px 1fr}
  }
</style>
</head>
<body>
  <main id="widget" role="group" aria-label="ISS overlay">
    <div class="title" id="title">—</div>

    <div class="row">
      <aside class="left">
        <div class="flagbox"><img id="flag" alt="" src=""></div>
        <div class="live">LIVE</div>
      </aside>

      <section class="info">
        <div class="kv" id="grid"><!-- populated by JS --></div>
      </section>
    </div>
  </main>

<script>
/* ==================== CONFIG ==================== */
const API_BASE   = 'https://iss-live.charlesleahy.workers.dev'; // change if needed
const REFRESH_MS = 6000;   // fetch ISS + reverse geocode cadence
const SLIDE_MS   = 7000;   // rotate between Stats <-> Country when on land

/* ==================== ELEMENTS ==================== */
const EL = {
  title: document.getElementById('title'),
  flag:  document.getElementById('flag'),
  grid:  document.getElementById('grid'),
};

/* ==================== UTILS ==================== */
const fmt = (n,d=2)=> (n==null||!isFinite(n)) ? '—' : Number(n).toFixed(d).replace(/\.00$/,'');
const nowUTC = ()=> new Date().toISOString().slice(11,19)+' UTC';
const todayUTC = ()=> new Date().toISOString().slice(0,10);

/* vMix-safe JSON (XHR) */
function getJSON(url, timeout=8000){
  return new Promise((resolve,reject)=>{
    try{
      const xhr = new XMLHttpRequest();
      xhr.open('GET', url, true);
      xhr.responseType = 'json';
      xhr.timeout = timeout;
      xhr.onload = ()=> (xhr.status>=200 && xhr.status<300)
        ? resolve(xhr.response ?? JSON.parse(xhr.responseText))
        : reject(new Error('HTTP '+xhr.status));
      xhr.onerror = ()=>reject(new Error('Network error'));
      xhr.ontimeout = ()=>reject(new Error('Timeout'));
      xhr.setRequestHeader('Cache-Control','no-cache');
      xhr.send();
    }catch(e){ reject(e); }
  });
}
const fetchISS  = ()=> getJSON(`${API_BASE}/iss`);
const fetchRG   = (lat,lon)=> getJSON(`${API_BASE}/rg?lat=${lat}&lon=${lon}&lang=en`); // ask for English if supported
const fetchFacts= (iso2)=> iso2 ? getJSON(`${API_BASE}/facts?iso2=${iso2}`) : Promise.resolve({});

/* ===== English-only helpers ===== */
const hasIntl = (typeof Intl!=='undefined' && Intl.DisplayNames);
const enDisplay = hasIntl ? new Intl.DisplayNames(['en'], {type:'region'}) : null;
const ISO2_EN = {
  US:'United States', GB:'United Kingdom', DE:'Germany', FR:'France', ES:'Spain',
  IT:'Italy', CN:'China', JP:'Japan', IN:'India', BR:'Brazil', RU:'Russia',
  CA:'Canada', AU:'Australia', MX:'Mexico', KR:'South Korea', TR:'Türkiye',
  ID:'Indonesia', NL:'Netherlands', SE:'Sweden', NO:'Norway', DK:'Denmark',
  FI:'Finland', PL:'Poland', UA:'Ukraine', SA:'Saudi Arabia', AE:'United Arab Emirates',
  ZA:'South Africa', AR:'Argentina', EG:'Egypt'
};
function countryNameEN(iso2, fallbackCountry){
  if(!iso2) return fallbackCountry || '—';
  const code = iso2.toUpperCase();
  try{ if(enDisplay){ const n = enDisplay.of(code); if(n) return n; } }catch(_){}
  return ISO2_EN[code] || fallbackCountry || code;
}
const englishText = s => (typeof s==='string') ? s.normalize('NFD').replace(/[\u0300-\u036f]/g,'') : s;

/* ===== Ocean name heuristic (English) ===== */
function whichOcean(lat, lon){
  lon = ((lon + 180) % 360 + 360) % 360 - 180;
  if (lat >= 66) return 'Arctic Ocean';
  if (lat <= -50) return 'Southern Ocean';
  if (lon >= 20 && lon <= 147 && lat >= -60 && lat <= 30) return 'Indian Ocean';
  if (lon >= -100 && lon <= 20 && lat >= -60 && lat <= 66) return 'Atlantic Ocean';
  return 'Pacific Ocean';
}

/* ===== Fixed ocean image ONLY (as requested) ===== */
const OCEAN_STATIC =
  "https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=192&h=144&q=70";
async function setOceanPicture(){ if(EL.flag.src !== OCEAN_STATIC){ EL.flag.src = OCEAN_STATIC; EL.flag.alt = 'Ocean'; } }

/* ===== Flag image for land ===== */
function setFlagFromISO(iso2){ EL.flag.src = `https://flagcdn.com/w160/${iso2.toLowerCase()}.png`; EL.flag.alt = 'Flag'; }

/* ==================== SLIDES (no headings, same panel) ==================== */
let slideIdx = 0, slideTimer = null, currentSlides = []; // each slide = () => render grid rows
let lastSlidesKey = '';

function setGridRows(rows){
  // rows: array of [label, value, unit?]
  EL.grid.innerHTML = '';
  for(const [k,v,unit] of rows){
    const kEl = document.createElement('div'); kEl.className='k'; kEl.textContent = k + ' :';
    const vEl = document.createElement('div'); vEl.className='v';
    if(unit){ vEl.innerHTML = `${v ?? '—'} <span class="unit">${unit}</span>`; }
    else { vEl.textContent = v ?? '—'; }
    EL.grid.appendChild(kEl); EL.grid.appendChild(vEl);
  }
}
function slideStats(iss){
  return ()=> setGridRows([
    ['UTC',  nowUTC(), ''],
    ['Date', todayUTC(), ''],
    ['Speed', fmt(iss.speed_kps,2), 'km/s'],
    ['Elev',  fmt(iss.alt_km,0),    'km'],
  ]);
}
function slideCountry(facts){
  const strip = englishText;
  return ()=> setGridRows([
    ['Capital', strip(facts.capital) ?? '—', ''],
    ['Density', facts.density ?? '—', ''],
    ['Poverty', facts.poverty ?? '—', ''],
  ]);
}
function startSlides(forceKey=''){
  const key = forceKey || String(currentSlides.length);
  if (slideTimer){ clearInterval(slideTimer); slideTimer = null; }
  slideIdx = 0;
  if (currentSlides.length){
    currentSlides[0]();
    if(currentSlides.length>1){
      slideTimer = setInterval(()=>{
        slideIdx = (slideIdx+1) % currentSlides.length;
        currentSlides[slideIdx]();
      }, SLIDE_MS);
    }
  } else {
    EL.grid.innerHTML='';
  }
  lastSlidesKey = key;
}
/* keep UTC ticking every second on the stats slide without rerendering all rows */
function startClock(){
  function tick(){
    const labels = EL.grid.querySelectorAll('.k');
    for(let i=0;i<labels.length;i++){
      if(labels[i].textContent.trim().startsWith('UTC')){
        const v = labels[i].nextElementSibling;
        if(v) v.firstChild ? v.firstChild.nodeValue = nowUTC() : v.textContent = nowUTC();
        break;
      }
    }
    setTimeout(tick, 1000 - (Date.now()%1000));
  }
  tick();
}

/* repaint helper to coax older CEF into painting the first line */
function repaint(el){ el.style.display='none'; void el.offsetHeight; el.style.display='block'; }

/* ==================== MAIN REFRESH ==================== */
async function refresh(){
  try{
    const iss = await fetchISS(); // {lat,lon,alt_km,speed_kps}

    // Default: over ocean until RG says otherwise
    EL.title.textContent = whichOcean(iss.lat, iss.lon); repaint(EL.title);
    setOceanPicture();

    // Slides default = Stats only
    currentSlides = [ slideStats(iss) ];
    startSlides('ocean');

    // Upgrade with reverse geocode (land/ocean details)
    fetchRG(iss.lat, iss.lon).then(async (meta)=>{
      if (meta && meta.iso2){
        // Build "City, Country" (English-only, with fallbacks)
        const country = countryNameEN(meta.iso2, meta.country);
        const city = englishText(
          meta.city || meta.locality || meta.town || meta.village || meta.municipality || meta.name || ''
        );
        const region = englishText(meta.region || meta.admin1 || '');
        const title =
          city ? `${city}, ${country}` :
          region ? `${region}, ${country}` :
          country;

        EL.title.textContent = title; repaint(EL.title);
        setFlagFromISO(meta.iso2);

        // Ensure the Country Info slide appears even if facts fail:
        let facts = {capital:'—', density:'—', poverty:'—'};
        try{
          const f = await fetchFacts(meta.iso2);
          if (f && typeof f === 'object') facts = Object.assign(facts, f);
        }catch(_){ /* keep placeholders */ }

        currentSlides = [ slideStats(iss), slideCountry(facts) ];
        startSlides('land');

      } else {
        // Stay ocean (English name from heuristic, fixed photo)
        EL.title.textContent = whichOcean(iss.lat, iss.lon); repaint(EL.title);
        setOceanPicture();
        currentSlides = [ slideStats(iss) ];
        startSlides('ocean');
      }
    }).catch(()=>{
      // keep ocean defaults
    });

  }catch(_){
    // leave previous render; clock still ticking
  }
}

/* ==================== BOOT ==================== */
startClock();
refresh();
setInterval(refresh, REFRESH_MS);
</script>
</body>
</html>
