<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ISS Info Widget</title>

<!-- silence favicon 404 -->
<link rel="icon" href='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg"/>'>

<!-- Sunrise/Sunset math -->
<script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>

<style>
  :root{ --w:520px; --h:280px; --bg:#0e0f12; --panel:#171a1f; --muted:#9aa4b2; --text:#e7edf5; --card:#101319; }
  html,body{height:100%;margin:0;background:transparent}
  *{box-sizing:border-box;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}

  .widget{width:var(--w);height:var(--h);display:grid;grid-template-rows:1fr 110px;gap:12px;padding:12px;
          background:var(--bg);color:var(--text);border:1px solid #262a34;border-radius:14px;box-shadow:0 10px 28px rgba(0,0,0,.48);overflow:hidden}

  .location{display:grid;place-items:center;background:linear-gradient(180deg,#12151c,#0e1116);border-radius:12px;border:1px solid #1e2530;padding:16px}
  #title{font-weight:800;letter-spacing:.3px;line-height:1.05;font-size:36px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-align:center}
  .location.small #title{font-size:30px}.location.tiny #title{font-size:24px}

  .bottom{display:grid;grid-template-columns:130px 1fr;gap:12px}

  .flagCard{background:var(--card);border:1px solid #1f2430;border-radius:12px;display:grid;grid-template-rows:1fr 26px;overflow:hidden}
  .flagWrap{display:flex;align-items:center;justify-content:center;padding:10px;background:radial-gradient(120% 140% at 50% 0%,#1a2230 0%,#0f141d 60%,#0b0e13 100%)}
  .flag{width:100%;height:100%;max-width:104px;max-height:70px;object-fit:cover;border-radius:8px;border:1px solid #2a3140;background:#0b0d10}
  .live{height:26px;background:#b80e0e;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:900;letter-spacing:.6px;text-transform:uppercase;font-size:13px}

  .info{background:var(--panel);border:1px solid #222937;border-radius:12px;padding:12px 14px;display:grid;grid-template-rows:auto 1fr auto;gap:8px}
  .rowTitle{font-weight:900;color:#cfd7e3;font-size:18px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px 18px;font-size:14px;line-height:1.25;align-content:start}
  .muted{color:var(--muted)} .mono{font-variant-numeric:tabular-nums;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .span2{grid-column:1/-1}
  .tappable{cursor:pointer;user-select:none}
  #dbg{opacity:.65;font-size:11px;color:#a8b0bd}
</style>
</head>

<body>
<div class="widget">
  <div class="location" id="loc"><div id="title">â€”</div></div>

  <div class="bottom">
    <div class="flagCard">
      <div class="flagWrap"><img id="flag" class="flag" alt="Flag" /></div>
      <div class="live">LIVE NOW</div>
    </div>

    <div class="info tappable" id="info">
      <div class="rowTitle" id="panelTitle">Next: â€”</div>

      <!-- Panel A: Now -->
      <div class="grid" id="panelNow">
        <div><span class="muted">UTC:</span>   <span class="mono" id="utc">â€”</span></div>
        <div><span class="muted">Date:</span>  <span class="mono" id="date">â€”</span></div>
        <div><span class="muted">Speed:</span> <span class="mono" id="speed">â€”</span></div>
        <div><span class="muted">Elev:</span>  <span class="mono" id="alt">â€”</span></div>
        <div class="span2"><span class="muted">Coords:</span> <span class="mono" id="coords">â€”</span></div>
      </div>

      <!-- Panel B: Country Information -->
      <div class="grid" id="panelFacts" style="display:none">
        <div class="span2"><strong>Country Information</strong></div>
        <div><span class="muted">Life Expectancy:</span> <span class="mono" id="leTotal">â€”</span></div>
        <div><span class="muted">Median Age:</span>     <span class="mono" id="medianAge">â€”</span></div>
        <div><span class="muted">Male:</span>           <span class="mono" id="leMale">â€”</span></div>
        <div><span class="muted">Female:</span>         <span class="mono" id="leFemale">â€”</span></div>
        <div><span class="muted">Land Area:</span>      <span class="mono" id="landArea">â€”</span></div>
        <div><span class="muted">Forest:</span>         <span class="mono" id="forest">â€”</span></div>
        <div><span class="muted">Pasture:</span>        <span class="mono" id="pasture">â€”</span></div>
      </div>

      <div id="dbg"></div>
    </div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const WORKER_BASE = "https://iss-live.charlesleahy.workers.dev";
const REFRESH_MS   = 6000;
const PANEL_SWAP_MS= 12000;
/* ================== */

const el=id=>document.getElementById(id);
const fmt2=new Intl.NumberFormat('en-US',{maximumFractionDigits:2});
const fmt3=new Intl.NumberFormat('en-US',{maximumFractionDigits:3});
const pad=n=>String(n).padStart(2,'0');

function setTitle(t){const box=el('loc');box.classList.remove('small','tiny');el('title').textContent=t||'â€”';const n=(t||'').length;if(n>28&&n<=44)box.classList.add('small');if(n>44)box.classList.add('tiny');}
const toUTCd=d=>`${d.getUTCFullYear()}-${pad(d.getUTCMonth()+1)}-${pad(d.getUTCDate())}`;
const toUTCt=d=>`${pad(d.getUTCHours())}:${pad(d.getUTCMinutes())}:${pad(d.getUTCSeconds())} UTC`;

async function j(url,timeout=8000){
  const ac=new AbortController();const t=setTimeout(()=>ac.abort(),timeout);
  try{const r=await fetch(url,{signal:ac.signal,cache:'no-store'});if(!r.ok)throw 0;return await r.json();}
  finally{clearTimeout(t);}
}

const OCEAN_SVG='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="96" height="64"><rect width="100%" height="100%" fill="%230b1a2a"/><text x="50%" y="55%" font-size="16" fill="white" text-anchor="middle" font-family="Segoe UI, Arial">ðŸŒŠ</text></svg>';

function nextSun(lat,lon){
  const now=new Date();const L=[];for(let d=0;d<2;d++){const dt=new Date(now.getTime()+d*86400000);const t=SunCalc.getTimes(dt,lat,lon);L.push({n:'Sunrise',t:t.sunrise},{n:'Sunset',t:t.sunset});}
  const nx=L.filter(x=>x.t&&x.t>now).sort((a,b)=>a.t-b.t)[0];if(!nx)return null;
  const mins=Math.round((nx.t-now)/60000);const label=mins<=0?'now':(mins<60?`${mins} min`:`${Math.floor(mins/60)} h ${mins%60} m`);
  return {label:`Next: ${nx.n} in ${label}`, at:nx.t};
}

let panel=0;function swap(){panel=(panel+1)%2;el('panelNow').style.display=panel?'none':'grid';el('panelFacts').style.display=panel?'grid':'none';}
el('info').addEventListener('click',swap);setInterval(swap,PANEL_SWAP_MS);

/* -------- main loop (Worker ONLY) -------- */
async function tick(){
  try{
    // 1) ISS from Worker only
    const iss = await j(`${WORKER_BASE}/iss`, 7000);
    el('dbg').textContent = `data source: ${iss.src||'worker'}`;

    if(!(Number.isFinite(iss.lat) && Number.isFinite(iss.lon))) return;

    el('coords').textContent = `${iss.lat.toFixed(2)}Â° ${iss.lat>=0?'N':'S'}, ${iss.lon.toFixed(2)}Â° ${iss.lon>=0?'E':'W'}`;
    el('speed').textContent  = iss.speed_kps!=null? `${fmt3.format(iss.speed_kps)} km/s` : 'â€”';
    el('alt').textContent    = iss.alt_km!=null  ? `${fmt2.format(iss.alt_km)} km`     : 'â€”';

    const sun = nextSun(iss.lat, iss.lon);
    if(sun){ el('panelTitle').textContent = sun.label; el('utc').textContent = toUTCt(sun.at); el('date').textContent = toUTCd(sun.at); }

    // 2) Reverse-geocode (Worker only)
    const place = await j(`${WORKER_BASE}/rg?lat=${iss.lat}&lon=${iss.lon}`, 7000);
    let title='â€”';
    if(!place.country && place.ocean) title = place.ocean || 'Open Ocean';
    else if(place.region && place.country) title = `${place.region}, ${place.country}`;
    else title = place.country || place.region || 'â€”';
    setTitle(title);

    const f=el('flag');
    if(place.iso2){ f.src=`https://flagcdn.com/w80/${place.iso2.toLowerCase()}.png`; }
    else{ f.src=OCEAN_SVG; }
    f.style.opacity='1';

    // 3) Country facts (public CORS-safe APIs; if they fail, just leave dashes)
    try{
      if(place.iso2){
        const rc = await j(`https://restcountries.com/v3.1/alpha/${place.iso2}`,7000);
        const r = Array.isArray(rc)?rc[0]:rc; const area=r?.area||null;
        el('landArea').textContent = area? `${Math.round(area).toLocaleString('en-US')} kmÂ²` : 'â€”';

        const WB = async code => { try{ const q=await j(`https://api.worldbank.org/v2/country/${place.iso2}/indicator/${code}?format=json&per_page=70`,8000); const s=q?.[1]||[]; const v=s.find(x=>x.value!==null); return (v&&typeof v.value==='number')?v.value:null; }catch{return null;} };
        const leT=await WB('SP.DYN.LE00.IN'), leM=await WB('SP.DYN.LE00.MA.IN'), leF=await WB('SP.DYN.LE00.FE.IN');
        const frK=await WB('AG.LND.FRST.K2'), frP=await WB('AG.LND.FRST.ZS');
        const paK=await WB('AG.LND.PAST.K2'), paP=await WB('AG.LND.PAST.ZS');
        const yrs=v=>v==null?'â€”':`${fmt2.format(v)} yrs`;
        el('leTotal').textContent=yrs(leT); el('leMale').textContent=yrs(leM); el('leFemale').textContent=yrs(leF);
        el('medianAge').textContent='â€”';
        el('forest').textContent=(frK==null&&frP==null)?'â€”':`${frK!=null?Math.round(frK).toLocaleString('en-US')+' kmÂ²':''}${frP!=null?` (${fmt2.format(frP)}%)`:''}`;
        el('pasture').textContent=(paK==null&&paP==null)?'â€”':`${paK!=null?Math.round(paK).toLocaleString('en-US')+' kmÂ²':''}${paP!=null?` (${fmt2.format(paP)}%)`:''}`;
      }
    }catch{}
  }catch(e){
    // If Worker is down, keep last good values and show a hint
    el('dbg').textContent = 'data source: worker error';
  }
}

/* Live UTC clock */
setInterval(()=>{const n=new Date(); el('date').textContent=`${n.getUTCFullYear()}-${pad(n.getUTCMonth()+1)}-${pad(n.getUTCDate())}`; el('utc').textContent=`${pad(n.getUTCHours())}:${pad(n.getUTCMinutes())}:${pad(n.getUTCSeconds())} UTC`;},1000);

tick();
setInterval(tick, REFRESH_MS);
</script>
</body>
</html>
