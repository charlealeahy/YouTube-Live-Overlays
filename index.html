<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ISS Info Widget</title>
<script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>
<script src="https://cdn.jsdelivr.net/npm/satellite.js@5.0.1/dist/satellite.min.js"></script>
<style>
  :root{ --w:480px; --h:260px; --bg:#0e0f12; --panel:#171a1f; --muted:#9aa4b2; --text:#e7edf5; --card:#101319; }
  html,body{height:100%;margin:0;background:transparent}
  *{box-sizing:border-box;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .widget{width:var(--w);height:var(--h);display:grid;grid-template-rows:1fr 96px;gap:10px;padding:10px;background:var(--bg);color:var(--text);border:1px solid #262a34;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.45);overflow:hidden}
  .location{display:grid;place-items:center;background:linear-gradient(180deg,#12151c,#0e1116);border-radius:12px;border:1px solid #1e2530;padding:14px}
  #title{font-weight:700;letter-spacing:.3px;line-height:1.05;font-size:34px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-align:center}
  .location.small #title{font-size:28px}.location.tiny #title{font-size:22px}
  .bottom{display:grid;grid-template-columns:120px 1fr;gap:10px}
  .flagCard{background:var(--card);border:1px solid #1f2430;border-radius:12px;display:grid;grid-template-rows:1fr 26px;overflow:hidden}
  .flagWrap{display:flex;align-items:center;justify-content:center;padding:10px;background:radial-gradient(120% 140% at 50% 0%,#1a2230 0%,#0f141d 60%,#0b0e13 100%)}
  .flag{width:100%;height:100%;max-width:96px;max-height:64px;object-fit:cover;border-radius:8px;border:1px solid #2a3140;background:#0b0d10}
  .live{background:#b80e0e;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:900;letter-spacing:.6px;text-transform:uppercase;font-size:13px}
  .info{background:var(--panel);border:1px solid #222937;border-radius:12px;padding:10px 12px;display:grid;grid-template-rows:auto 1fr;gap:6px}
  .rowTitle{font-weight:900;color:#cfd7e3;font-size:18px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:6px 18px;font-size:14px;line-height:1.25;align-content:start}
  .muted{color:var(--muted)} .mono{font-variant-numeric:tabular-nums;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .span2{grid-column:1/-1}
  .tappable{cursor:pointer;user-select:none}
</style>
</head>
<body>
<div class="widget">
  <div class="location" id="loc"><div id="title">—</div></div>
  <div class="bottom">
    <div class="flagCard">
      <div class="flagWrap"><img id="flag" class="flag" alt="Flag"/></div>
      <div class="live">LIVE NOW</div>
    </div>
    <div class="info tappable" id="info">
      <div class="rowTitle" id="panelTitle">Next: —</div>
      <div class="grid" id="panelNow">
        <div><span class="muted">UTC:</span>   <span class="mono" id="utc">—</span></div>
        <div><span class="muted">Date:</span>  <span class="mono" id="date">—</span></div>
        <div><span class="muted">Speed:</span> <span class="mono" id="speed">—</span></div>
        <div><span class="muted">Elev:</span>  <span class="mono" id="alt">—</span></div>
        <div class="span2"><span class="muted">Coords:</span> <span class="mono" id="coords">—</span></div>
      </div>
      <div class="grid" id="panelFacts" style="display:none">
        <div class="span2"><strong>Country Information</strong></div>
        <div><span class="muted">Life Expectancy:</span> <span class="mono" id="leTotal">—</span></div>
        <div><span class="muted">Median Age:</span> <span class="mono" id="medianAge">—</span></div>
        <div><span class="muted">Male:</span>   <span class="mono" id="leMale">—</span></div>
        <div><span class="muted">Female:</span> <span class="mono" id="leFemale">—</span></div>
        <div><span class="muted">Land Area:</span>   <span class="mono" id="landArea">—</span></div>
        <div><span class="muted">Forest:</span>      <span class="mono" id="forest">—</span></div>
        <div><span class="muted">Pasture:</span>     <span class="mono" id="pasture">—</span></div>
      </div>
    </div>
  </div>
</div>

<script>
const WORKER_BASE = "https://iss-live.charlesleahy.workers.dev"; // <-- your Worker
const REFRESH_MS = 6000, PANEL_SWAP_MS = 12000;
const el = id => document.getElementById(id);
const fmt2 = new Intl.NumberFormat('en-US',{maximumFractionDigits:2});
const fmt3 = new Intl.NumberFormat('en-US',{maximumFractionDigits:3});
const pad  = n => String(n).padStart(2,'0');
function setTitle(text){const b=el('loc');b.classList.remove('small','tiny');el('title').textContent=text||'—';const n=(text||'').length;if(n>28&&n<=44)b.classList.add('small');if(n>44)b.classList.add('tiny');}
async function j(u,timeout=8000){const c=new AbortController();const t=setTimeout(()=>c.abort(),timeout);const r=await fetch(u,{signal:c.signal,cache:'no-store'}).catch(()=>null);clearTimeout(t);if(!r||!r.ok)throw 0;return r.json();}
function nextSun(lat,lon){const now=new Date();const L=[];for(let d=0;d<2;d++){const dt=new Date(now.getTime()+d*86400000);const t=SunCalc.getTimes(dt,lat,lon);L.push({n:'Sunrise',t:t.sunrise},{n:'Sunset',t:t.sunset});}const nx=L.filter(x=>x.t>now).sort((a,b)=>a.t-b.t)[0];if(!nx)return null;const mins=Math.round((nx.t-now)/60000);const inTxt=mins<=0?'now':(mins<60?`${mins} min`:`${Math.floor(mins/60)} h ${mins%60} m`);return{label:`Next: ${nx.n} in ${inTxt}`,at:nx.t};}
const toUTCd=d=>`${d.getUTCFullYear()}-${pad(d.getUTCMonth()+1)}-${pad(d.getUTCDate())}`;
const toUTCt=d=>`${pad(d.getUTCHours())}:${pad(d.getUTCMinutes())}:${pad(d.getUTCSeconds())} UTC`;
let panel=0;function swap(){panel=(panel+1)%2;el('panelNow').style.display=panel? 'none':'grid';el('panelFacts').style.display=panel? 'grid':'none';}
el('info').addEventListener('click',swap);setInterval(swap,PANEL_SWAP_MS);
async function tick(){
  try{
    const iss=await j(`${WORKER_BASE}/iss`);
    if(!(Number.isFinite(iss.lat)&&Number.isFinite(iss.lon))) return;
    el('coords').textContent=`${iss.lat.toFixed(2)}° ${iss.lat>=0?'N':'S'}, ${iss.lon.toFixed(2)}° ${iss.lon>=0?'E':'W'}`;
    if(iss.speed_kps!=null) el('speed').textContent=`${fmt3.format(iss.speed_kps)} km/s`;
    if(iss.alt_km!=null)    el('alt').textContent=`${fmt2.format(iss.alt_km)} km`;
    const sun=nextSun(iss.lat,iss.lon); if(sun){ el('panelTitle').textContent=sun.label; el('utc').textContent=toUTCt(sun.at); el('date').textContent=toUTCd(sun.at); }
    const place=await j(`${WORKER_BASE}/rg?lat=${iss.lat}&lon=${iss.lon}`);
    let title='—'; if(!place.country&&place.ocean) title=place.ocean||'Open Ocean'; else if(place.region&&place.country) title=`${place.region}, ${place.country}`; else title=place.country||place.region||'—'; setTitle(title);
    if(place.iso2){const f=el('flag'); f.src=`https://flagcdn.com/w80/${place.iso2.toLowerCase()}.png`; f.style.opacity='1';
      // facts (WB + REST)
      try{
        const rc = await j(`https://restcountries.com/v3.1/alpha/${place.iso2}`);
        const r = Array.isArray(rc)?rc[0]:rc; const area = r?.area||null; el('landArea').textContent = area? `${Math.round(area).toLocaleString('en-US')} km²`:'—';
      }catch{}
      const WB=async(code)=>{try{const q=await j(`https://api.worldbank.org/v2/country/${place.iso2}/indicator/${code}?format=json&per_page=70`);const s=q?.[1]||[];const v=s.find(x=>x.value!==null);return typeof v?.value==='number'?v.value:null;}catch{return null}};
      const leT=await WB('SP.DYN.LE00.IN'), leM=await WB('SP.DYN.LE00.MA.IN'), leF=await WB('SP.DYN.LE00.FE.IN');
      el('leTotal').textContent=leT!=null?`${fmt2.format(leT)} yrs`:'—';
      el('leMale').textContent =leM!=null?`${fmt2.format(leM)} yrs`:'—';
      el('leFemale').textContent=leF!=null?`${fmt2.format(leF)} yrs`:'—';
      const frK=await WB('AG.LND.FRST.K2'), frP=await WB('AG.LND.FRST.ZS'); el('forest').textContent=(frK==null&&frP==null)?'—':`${frK!=null?Math.round(frK).toLocaleString('en-US')+' km²':''}${frP!=null?` (${fmt2.format(frP)}%)`:''}`;
      const paK=await WB('AG.LND.PAST.K2'), paP=await WB('AG.LND.PAST.ZS'); el('pasture').textContent=(paK==null&&paP==null)?'—':`${paK!=null?Math.round(paK).toLocaleString('en-US')+' km²':''}${paP!=null?` (${fmt2.format(paP)}%)`:''}`;
      el('medianAge').textContent='—'; // (no free CORS-safe source)
    }
  }catch{}
}
setInterval(()=>{const n=new Date(); el('date').textContent=toUTCd(n); el('utc').textContent=toUTCt(n);},1000);
tick(); setInterval(tick,REFRESH_MS);
</script>
</body>
</html>
