<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ISS Info Widget</title>
<style>
  :root{
    --w: 560px;          /* overall widget width */
    --panel: #0f1a22;    /* card surface */
    --panel2:#0b141b;    /* header surface */
    --ink:  #eaf3ff;     /* main text */
    --mut:  #a9b4c0;     /* subtle text */
    --accent:#3aa0ff;    /* accent/cursor */
    --live:#cc1b1b;      /* LIVE pill */
    --ring:#0c1115;      /* outer background */
    --shadow: rgba(9,15,20,.55);
  }

  *{ box-sizing: border-box; }
  html,body{
    height:100%; margin:0; background:linear-gradient(180deg,#0a1116,#0a1116 60%,#0b141b);
    color:var(--ink); font: 16px/1.35 system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  }

  .widget{
    width:var(--w);
    margin:22px 0 0 18px;
    background:radial-gradient(1200px 120px at -80px -80px, #0d1720, #0a1116);
    padding:16px 16px 18px;
    border-radius:18px;
    box-shadow:
      0 28px 60px var(--shadow),
      inset 0 0 0 1px #0c141b;
  }

  /* Title bar */
  .title{
    display:flex; align-items:center; justify-content:center;
    background:var(--panel2);
    border-radius:14px; height:56px; padding:0 16px; margin-bottom:12px;
    box-shadow: inset 0 0 0 1px #0e1820;
  }
  .title h1{
    margin:0; font-weight:700; letter-spacing:.2px; font-size:26px; text-align:center;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }

  /* Body row */
  .row{
    display:grid; grid-template-columns:120px 1fr; gap:12px;
  }

  /* Flag + LIVE (locked alignment) */
  .flagCol{
    display:flex; flex-direction:column; align-items:center; gap:10px;
  }
  .flag{
    width:96px; height:64px; display:block; object-fit:cover; border-radius:8px;
    box-shadow: 0 10px 30px rgba(0,0,0,.35);
    background:#0a1116;
  }
  .live{
    width:96px; height:32px; display:flex; align-items:center; justify-content:center;
    background: linear-gradient(#f04545, #bb1414);
    color:white; font-weight:800; letter-spacing:.6px; border-radius:9px;
    box-shadow: 0 4px 14px rgba(204,27,27,.45), inset 0 0 0 1px rgba(255,255,255,.08);
  }

  /* Info deck (slides) */
  .deck{
    background:var(--panel);
    border-radius:14px;
    box-shadow: inset 0 0 0 1px #0d1821, 0 18px 40px var(--shadow);
    padding:14px 16px 10px; position:relative; overflow:hidden;
    min-height:168px;
  }
  .slides{ position:relative; }
  .slide{
    position:absolute; inset:0; padding:6px 4px 6px;
    opacity:0; transform:translateY(8px); transition:opacity .35s ease, transform .35s ease;
    display:none;
  }
  .slide.active{ display:block; opacity:1; transform:none; }

  .grid{
    display:grid; grid-template-columns: 140px 1fr;
    row-gap:8px; column-gap:12px;
  }
  .lab{ color:var(--mut); text-align:left; }
  .val{ font-weight:650; }

  .twoCol{
    display:grid; grid-template-columns: 1fr 1fr; gap:10px 24px;
  }

  .section{
    margin:6px 2px 10px; font-weight:800; color:#cfe7ff; letter-spacing:.2px;
  }

  /* Progress bar */
  .bar{
    position:absolute; left:0; bottom:0; height:3px; width:0%;
    background:linear-gradient(90deg, var(--accent), #87c7ff);
    box-shadow:0 0 10px #3aa0ff;
    transition: none;
  }

  /* Small helpers */
  .mono{ font-variant-numeric: tabular-nums; }
  .unit{ color:var(--mut); font-weight:500; margin-left:4px; }

  /* Tighter look on narrow displays */
  @media (max-width:620px){
    :root{ --w: 520px; }
    .grid{ grid-template-columns: 120px 1fr; }
  }
</style>
</head>
<body>
  <div class="widget">
    <div class="title"><h1 id="title">—</h1></div>

    <div class="row">
      <div class="flagCol">
        <img id="flag" class="flag" alt="flag" src="" />
        <div class="live">LIVE</div>
      </div>

      <div class="deck">
        <div class="slides">
          <!-- Slide A: NOW -->
          <div class="slide active" id="slide-now">
            <div class="grid">
              <div class="lab">UTC :</div><div class="val mono" id="utc">—</div>
              <div class="lab">Date :</div><div class="val mono" id="date">—</div>
              <div class="lab">Speed :</div><div class="val mono"><span id="speed">—</span><span class="unit">km/s</span></div>
              <div class="lab">Elev :</div><div class="val mono"><span id="elev">—</span><span class="unit">km</span></div>
            </div>
          </div>

          <!-- Slide B: Country info -->
          <div class="slide" id="slide-country">
            <div class="section">Country Information</div>
            <div class="grid">
              <div class="lab">Capital :</div><div class="val" id="capital">—</div>
              <div class="lab">Density :</div><div class="val mono"><span id="density">—</span><span class="unit">ppl/km²</span></div>
              <div class="lab">Poverty :</div><div class="val mono" id="poverty">—</div>
            </div>
          </div>

          <!-- Slide C: Life & Age -->
          <div class="slide" id="slide-life">
            <div class="section">Life &amp; Age</div>
            <div class="grid twoCol">
              <div class="lab">Life Expectancy :</div><div class="val mono"><span id="lifeExp">—</span><span class="unit">yrs</span></div>
              <div class="lab">Median Age :</div><div class="val mono"><span id="medianAge">—</span><span class="unit">yrs</span></div>
              <div class="lab">Male :</div><div class="val mono"><span id="male">—</span><span class="unit">yrs</span></div>
              <div class="lab">Female :</div><div class="val mono"><span id="female">—</span><span class="unit">yrs</span></div>
            </div>
          </div>
        </div>

        <div class="bar" id="bar"></div>
      </div>
    </div>
  </div>

<script>
(function(){
  const BASE = 'https://iss-live.charlesleahy.workers.dev';
  const ROTATE_MS = 6500;        // time each slide is shown
  const slides = ['slide-now','slide-country','slide-life'];
  let slideIdx = 0;
  const $ = id => document.getElementById(id);

  function safe(n, d='—'){
    return (n===null || n===undefined || n!==n || n==='' ) ? d : n;
  }
  function fmtNum(n, dp=0){
    if(n===null || n===undefined || n!==n) return '—';
    return Number(n).toLocaleString('en-US',{ maximumFractionDigits: dp, minimumFractionDigits: dp });
  }

  // Progress bar animation
  let barTimer;
  function runBar(){
    const bar = $('bar');
    bar.style.transition = 'none';
    bar.style.width = '0%';
    // async let layout settle
    requestAnimationFrame(()=>{
      requestAnimationFrame(()=>{
        bar.style.transition = `width ${ROTATE_MS}ms linear`;
        bar.style.width = '100%';
      });
    });
    clearTimeout(barTimer);
    barTimer = setTimeout(()=>{}, ROTATE_MS);
  }

  function showSlide(i){
    slideIdx = i % slides.length;
    slides.forEach((id, k)=>{
      const node = $(id);
      node.classList.toggle('active', k===slideIdx);
    });
    runBar();
  }

  setInterval(()=>showSlide(slideIdx+1), ROTATE_MS);

  // realtime UTC clock tick
  function tickUTC(){
    const d = new Date();
    $('utc').textContent = d.toISOString().slice(11,19) + ' UTC';
  }
  setInterval(tickUTC, 1000);
  tickUTC();

  // Load data
  (async function init(){
    try{
      // 1) ISS snapshot
      const iss = await fetchJSON(`${BASE}/iss`);
      const lat = iss.lat, lon = iss.lon;
      $('speed').textContent = fmtNum(iss.speed_kps,2);
      $('elev').textContent  = fmtNum(iss.alt_km,0);
      $('date').textContent  = new Date().toISOString().slice(0,10);

      // 2) Reverse geocode
      const rg  = await fetchJSON(`${BASE}/rg?lat=${lat.toFixed(3)}&lon=${lon.toFixed(3)}`);
      const iso2 = rg.iso2 || null;
      const title = (rg.region ? `${rg.region}, ` : '') + (rg.country || rg.ocean || '—');
      $('title').textContent = title;

      // flag or ocean icon
      setFlag(iso2, rg.ocean);

      // 3) Country facts
      if(iso2){
        const facts = await fetchJSON(`${BASE}/facts?iso2=${iso2}`).catch(()=>({}));
        $('capital').textContent = safe(facts.capital);
        $('density').textContent = (facts.density && /\d/.test(facts.density))
          ? facts.density.replace(' ppl/km²','') : '—';
        $('poverty').textContent = safe(facts.poverty);
      }

      // 4) Life & Age (if your worker exposes it; else keep dashes)
      //   If your Worker has /life?iso2=XX returning:
      //   { lifeExp, median, male, female }
      //   uncomment the block below:
      /*
      if(iso2){
        const life = await fetchJSON(`${BASE}/life?iso2=${iso2}`).catch(()=>({}));
        if(life){
          $('lifeExp').textContent  = fmtNum(life.lifeExp,1);
          $('medianAge').textContent= fmtNum(life.median,1);
          $('male').textContent     = fmtNum(life.male,1);
          $('female').textContent   = fmtNum(life.female,1);
        }
      }
      */

      // If country info (facts) didn’t load, skip that slide to keep things tidy
      tidySlides();
      runBar();
    }catch(err){
      console.error(err);
      tidySlides();
      runBar();
    }
  })();

  async function fetchJSON(u, timeout=7000){
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), timeout);
    const r = await fetch(u, {signal: ctrl.signal, headers: {'user-agent':'iss-widget'}});
    clearTimeout(t);
    if(!r.ok) throw new Error(`HTTP ${r.status} for ${u}`);
    return r.json();
  }

  function setFlag(iso2, ocean){
    const el = $('flag');
    if(ocean){
      el.src = 'https://img.icons8.com/fluency/96/sea-waves.png';
      el.alt = 'Ocean';
      return;
    }
    if(iso2){
      const cc = iso2.toLowerCase();
      el.src = `https://flagcdn.com/w160/${cc}.png`;
      el.srcset = `https://flagcdn.com/w160/${cc}.png 1x, https://flagcdn.com/w320/${cc}.png 2x`;
      el.alt = iso2 + ' flag';
    }else{
      el.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="96" height="64"><rect width="96" height="64" fill="%230c141b"/></svg>';
      el.alt = '';
    }
  }

  function tidySlides(){
    // If an entire slide has only dashes, hide it from rotation
    const checks = {
      'slide-country': ['capital','density','poverty'],
      'slide-life':    ['lifeExp','medianAge','male','female']
    };
    const keep = ['slide-now'];
    Object.entries(checks).forEach(([id, ids])=>{
      const any = ids.some(k => (($(k).textContent || '').trim() !== '—'));
      if(any) keep.push(id);
    });
    // Rebuild slides array in place
    slides.length = 0;
    keep.forEach(id=>slides.push(id));

    // Toggle visibility accordingly
    ['slide-country','slide-life'].forEach(id=>{
      $(id).style.display = keep.includes(id) ? 'block' : 'none';
      $(id).classList.remove('active');
    });
    // Ensure we start on NOW and then rotate through what’s left
    showSlide(0);
  }
})();
</script>
</body>
</html>
