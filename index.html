<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=440, initial-scale=1" />
<title>ISS Overlay 440×240</title>
<link rel="preconnect" href="https://api.wheretheiss.at">
<link rel="preconnect" href="https://api.bigdatacloud.net">
<link rel="preconnect" href="https://nominatim.openstreetmap.org">
<link rel="preconnect" href="https://api.unsplash.com">
<link rel="preconnect" href="https://flagcdn.com">
<link rel="preconnect" href="https://api.worldbank.org">
<link rel="preconnect" href="https://restcountries.com">
<script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>
<style>
:root{
  --card:#0c1116; --top:#0f141a; --panel:#1a2128; --stroke:#30373e;
  --text:#e8eef4; --muted:#a8b3be; --hdr:#4b535b; --live:#b11313;
}
*{box-sizing:border-box;font-family:Segoe UI,Roboto,Arial,sans-serif}
html,body{margin:0;background:#0a0f15}
body{padding:12px}

/* CARD */
.card{width:440px;height:240px;color:var(--text);border:1px solid #263039;border-radius:10px;background:var(--card);overflow:hidden}

/* TOP — big centered title only */
.top{
  height:112px;background:var(--top);
  display:flex;align-items:center;justify-content:center;
  border-bottom:1px solid #222a31;position:relative
}
.place{
  font-weight:600;font-size:44px;letter-spacing:.2px;
  max-width:92%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-align:center;z-index:2
}
/* no flag in the top bar */
.flagWrap{display:none !important}

/* BOTTOM ROW */
.row{height:128px;display:grid;grid-template-columns:176px 12px 1fr;padding:12px}

/* Left block: flag (land) or ocean photo (water) */
.left{position:relative;width:176px;height:96px;border:1px solid #8ea0ae;border-radius:6px;overflow:hidden;background:#4c5b66}
.left img{width:100%;height:100%;object-fit:cover;display:block}
.live{
  position:absolute;left:50%;transform:translateX(-50%);bottom:-24px;
  background:var(--live);color:#fff;font-weight:800;font-size:14px;
  padding:4px 10px;border-radius:6px;box-shadow:0 2px 8px #0007
}
.credit{position:absolute;right:6px;bottom:4px;font-size:10px;color:#c9d6e4;background:#0009;padding:2px 6px;border-radius:4px}

/* Right panel */
.panel{background:var(--panel);border:1px solid var(--stroke);border-radius:6px;padding:0 10px 10px 10px;display:grid;grid-template-rows:auto auto auto auto;row-gap:6px}
.hdr{height:30px;margin:-1px -10px 8px -10px;background:var(--hdr);display:flex;align-items:center;padding:0 10px;border-top-left-radius:6px;border-top-right-radius:6px;font-weight:800;font-size:18px}
.line{display:flex;justify-content:space-between;font-size:16px;color:var(--muted)}
.line b{color:var(--text);font-weight:600}
</style>
</head>
<body>
<div class="card">
  <div class="top">
    <div class="flagWrap" id="bigFlag"></div>
    <div class="place" id="place">Loading…</div>
  </div>

  <div class="row">
    <div class="left">
      <img id="thumb" alt="flag or ocean photo">
      <div class="credit" id="credit" hidden></div>
      <div class="live">LIVE NOW</div>
    </div>
    <div></div>
    <div class="panel">
      <div class="hdr" id="hdr">Now: —</div>
      <div class="line"><span id="l1a">—</span><b id="l1b">—</b></div>
      <div class="line"><span id="l2a">—</span><b id="l2b">—</b></div>
      <div class="line"><span id="l3a">—</span><b id="l3b">—</b></div>
    </div>
  </div>
</div>

<script>
/*** CONFIG ***/
const UNSPLASH_ACCESS_KEY = "b-noVjyVf5IBRDh5VaZP6HR0apDT8IwonBdoF_TBZk4"; // your key
const DEFAULT_OCEAN = "https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=512&h=384&fit=crop&auto=format";
const STATS_MS = 1000, GEO_MS = 10000, TOGGLE_MS = 15000;

const el = {
  place: document.getElementById('place'),
  thumb: document.getElementById('thumb'),
  credit: document.getElementById('credit'),
  hdr: document.getElementById('hdr'),
  l1a: document.getElementById('l1a'), l1b: document.getElementById('l1b'),
  l2a: document.getElementById('l2a'), l2b: document.getElementById('l2b'),
  l3a: document.getElementById('l3a'), l3b: document.getElementById('l3b'),
};
const nf0=new Intl.NumberFormat("en-US");
const nf2=new Intl.NumberFormat("en-US",{maximumFractionDigits:2,minimumFractionDigits:2});
const norm=s=>(s||"").toLowerCase().trim();

/*** helpers ***/
async function getISS(){
  const u=new URL("https://api.wheretheiss.at/v1/satellites/25544"); u.searchParams.set("_",Date.now());
  const r=await fetch(u,{cache:"no-store"}); if(!r.ok) throw new Error("ISS "+r.status);
  const j=await r.json();
  return {lat:j.latitude, lon:j.longitude, speed_kms:j.velocity/3600, elev_km:j.altitude, utc:new Date(j.timestamp*1000)};
}
function dtParts(d){
  const date=d.toLocaleDateString("en-US",{month:"short",day:"2-digit",year:"numeric"});
  const time=d.toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:false,timeZone:"UTC"})+" UTC";
  return {date,time};
}
function sunState(lat,lon,date){
  const t=SunCalc.getTimes(date,lat,lon), n=date.getTime();
  if(n>=t.sunrise.getTime()&&n<=t.sunriseEnd.getTime()) return "Sunrise";
  if(n>=t.sunsetStart.getTime()&&n<=t.sunset.getTime()) return "Sunset";
  if(n>t.sunriseEnd.getTime()&&n<t.sunsetStart.getTime()) return "Daylight";
  return "Night";
}

/*** robust place detection ***/
function oceanFromBDC(info){
  const arr=info&&Array.isArray(info.informative)?info.informative:[];
  const hit=arr.find(x=>/ocean|sea|gulf|bay|channel|strait/i.test((x.name||x.description||"")));
  return hit?hit.name:null;
}
function guessOcean(lat,lon){
  if(lat>=66) return "Arctic Ocean";
  if(lat<=-60) return "Southern Ocean";
  if(lon<=-70 || lon>=147) return "Pacific Ocean";
  if(lon>20 && lon<147){ return (lat<30? "Indian Ocean" : "Indian Ocean"); }
  return "Atlantic Ocean";
}
async function nominatimMulti(lat,lon){
  for(const z of [3,2,1]){
    const u=new URL("https://nominatim.openstreetmap.org/reverse");
    u.searchParams.set("format","jsonv2"); u.searchParams.set("zoom",String(z));
    u.searchParams.set("lat",lat); u.searchParams.set("lon",lon); u.searchParams.set("accept-language","en");
    const r=await fetch(u,{cache:"no-store",headers:{'User-Agent':'ISS-Overlay'}});
    if(r.ok){
      const j=await r.json();
      const name=j?.name || j?.display_name || j?.address?.country;
      const code=(j?.address?.country_code||"").toLowerCase();
      if(name){
        const isOcean=/ocean|sea|gulf|bay|channel|strait/i.test(name) && !j?.address?.country;
        return {label:name, isOcean, code:isOcean?null:code};
      }
    }
  }
  return null;
}
async function mapsCo(lat,lon){
  try{
    const u=new URL("https://geocode.maps.co/reverse");
    u.searchParams.set("format","json"); u.searchParams.set("lat",lat); u.searchParams.set("lon",lon);
    const r=await fetch(u,{cache:"no-store"}); if(!r.ok) return null;
    const j=await r.json();
    const name=j?.name || j?.display_name || j?.address?.country;
    const code=(j?.address?.country_code||"").toLowerCase();
    if(name){
      const isOcean=/ocean|sea|gulf|bay|channel|strait/i.test(name) && !j?.address?.country;
      return {label:name, isOcean, code:isOcean?null:code};
    }
  }catch{}
  return null;
}
async function getPlace(lat, lon){
  // 1) BigDataCloud
  try{
    const u=new URL("https://api.bigdatacloud.net/data/reverse-geocode-client");
    u.searchParams.set("latitude",lat); u.searchParams.set("longitude",lon); u.searchParams.set("localityLanguage","en");
    const r=await fetch(u,{cache:"no-store"});
    if(r.ok){
      const j=await r.json();
      const oc=oceanFromBDC(j.localityInfo);
      if(oc) return {label:oc,isOcean:true,code:null};
      if(j.countryName) return {label:j.countryName,isOcean:false,code:(j.countryCode||"").toLowerCase()};
    }
  }catch{}
  // 2) Nominatim multi-zoom
  const nm = await nominatimMulti(lat,lon); if(nm) return nm;
  // 3) maps.co fallback
  const mc = await mapsCo(lat,lon); if(mc) return mc;
  // 4) last-resort ocean guess (prevents "Earth" and blocks country info)
  return {label:guessOcean(lat,lon), isOcean:true, code:null};
}

/*** left visual ***/
function paintThumb(url,credit){
  const i=new Image();
  i.onload=()=>{ el.thumb.src=url; el.credit.textContent=credit||""; el.credit.hidden=!credit; };
  i.src=url;
}
async function oceanPhoto(place){
  const u=new URL("https://api.unsplash.com/search/photos");
  u.searchParams.set("query",`${place} ocean seascape horizon`);
  u.searchParams.set("orientation","landscape");
  u.searchParams.set("content_filter","high");
  u.searchParams.set("per_page","1");
  u.searchParams.set("client_id",UNSPLASH_ACCESS_KEY);
  const r=await fetch(u,{cache:"no-store"}); if(!r.ok) throw new Error("Unsplash "+r.status);
  const j=await r.json(); if(!j.results?.length) throw new Error("No results");
  const p=j.results[0];
  return {url:p.urls.raw+"&w=512&h=384&fit=crop&auto=format", credit:`${p.user.name} / Unsplash`};
}
async function setLeftVisual(place,isOcean,code){
  if(isOcean){
    try{
      const {url,credit}=await oceanPhoto(place);
      paintThumb(url,credit);
    }catch{ paintThumb(DEFAULT_OCEAN,""); }
  }else{
    if(code){ paintThumb(`https://flagcdn.com/w320/${code}.png`,""); }
    else{ paintThumb(DEFAULT_OCEAN,""); }
  }
}

/*** country info ***/
const cache=new Map(); // iso2 -> {population, growth, migPer1k}
async function getCountryInfo(iso2){
  if(!iso2) return null;
  const key=iso2.toLowerCase(); if(cache.has(key)) return cache.get(key);
  try{
    const rc=await (await fetch(`https://restcountries.com/v3.1/alpha/${key}?fields=population`)).json();
    const population=Array.isArray(rc)?rc[0]?.population:rc?.population;

    const g=await (await fetch(`https://api.worldbank.org/v2/country/${key}/indicator/SP.POP.GROW?format=json&per_page=60`)).json();
    let growth=null; if(Array.isArray(g)&&Array.isArray(g[1])){const row=g[1].find(x=>x&&x.value!=null); if(row) growth=row.value;}

    const m=await (await fetch(`https://api.worldbank.org/v2/country/${key}/indicator/SM.POP.NETM?format=json&per_page=60`)).json();
    let migPer1k=null; if(Array.isArray(m)&&Array.isArray(m[1])&&population){const row=m[1].find(x=>x&&x.value!=null); if(row){const perYear=row.value/5; migPer1k=(perYear/population)*1000;}}

    const out={population,growth,migPer1k}; cache.set(key,out); return out;
  }catch{return null;}
}

/*** modes ***/
let panelMode="status"; // "status" | "info"
const canShowInfo = s => !s.isOcean && s.code; // only when we truly have a country
let lastToggle=0;

/*** main loop ***/
let lastPlace="", lastGeo={t:0,lat:0,lon:0}, lastState={isOcean:true,code:null,label:""};

async function tick(){
  const iss=await getISS();
  const {date,time}=dtParts(iss.utc);
  const stateTxt=sunState(iss.lat,iss.lon,iss.utc);

  // place (throttled)
  const moved=Math.abs(iss.lat-lastGeo.lat)+Math.abs(iss.lon-lastGeo.lon)>0.75;
  const due=(Date.now()-lastGeo.t)>GEO_MS;
  if(moved||due||!lastPlace){
    const p=await getPlace(iss.lat,iss.lon);
    lastGeo={t:Date.now(),lat:iss.lat,lon:iss.lon};
    lastState=p;
    el.place.textContent=p.label;
    if(norm(p.label)!==norm(lastPlace)){ lastPlace=p.label; setLeftVisual(p.label,p.isOcean,p.code); }
  }

  // toggle every TOGGLE_MS (only to info if we have a real country)
  if(Date.now()-lastToggle>TOGGLE_MS){
    lastToggle=Date.now();
    panelMode = (panelMode==="status" ? (canShowInfo(lastState)?"info":"status") : "status");
  }

  if(panelMode==="status"){
    el.hdr.textContent=`Now: ${stateTxt} (1 of 16)`;
    el.l1a.textContent=date; el.l1b.textContent=time;
    el.l2a.textContent=`${iss.speed_kms.toFixed(4)} km/s`; el.l2b.textContent=`Elev: ${iss.elev_km.toFixed(1)} km`;
    el.l3a.textContent=`${Math.abs(iss.lat).toFixed(2)} °${iss.lat>=0?"N":"S"}`;
    el.l3b.textContent=`${Math.abs(iss.lon).toFixed(2)} °${iss.lon>=0?"E":"W"}`;
  }else{
    el.hdr.textContent=`Country Information`;
    const info=await getCountryInfo(lastState.code);
    const pop = info?.population? nf0.format(info.population) : "—";
    const grow= info?.growth!=null? `${nf2.format(info.growth)}%` : "—";
    const mig = info?.migPer1k!=null? `${nf2.format(info.migPer1k)}/1000 ppl.` : "—";
    el.l1a.textContent=`Population:`;      el.l1b.textContent=pop;
    el.l2a.textContent=`Growth Rate:`;     el.l2b.textContent=grow;
    el.l3a.textContent=`Migration Rate:`;  el.l3b.textContent=mig;
  }
}
tick();
setInterval(tick, STATS_MS);
</script>
</body>
</html>
