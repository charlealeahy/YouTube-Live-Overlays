<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ISS Tracker (GitHub Pages)</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Day/Night Terminator -->
<script src="https://cdn.jsdelivr.net/npm/@joergdietrich/leaflet.terminator@1.1.0/L.Terminator.js"></script>

<!-- Orbit propagation -->
<script src="https://unpkg.com/satellite.js@5.0.1/dist/satellite.min.js"></script>

<style>
  html,body{height:100%;margin:0;background:#0b1016;color:#e8eef4;font:14px/1.4 system-ui,Segoe UI,Roboto,Arial,sans-serif}
  #app{display:grid;grid-template-rows:auto 1fr}
  header{padding:10px 12px;border-bottom:1px solid #1e2730;background:#0f141a;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  header h1{margin:0;font-size:18px;font-weight:700}
  header .stat{margin-left:8px}
  header label{opacity:.8;margin-left:12px}
  #map{height:calc(100vh - 52px)}
  .leaflet-control-attribution{display:none}
  .panel{
    position:absolute;top:64px;left:10px;z-index:1000;background:#111923cc;border:1px solid #2a3440;
    border-radius:8px;padding:10px 12px;backdrop-filter:blur(2px);min-width:240px
  }
  .panel h2{margin:0 0 8px;font-size:14px;font-weight:800;color:#b8c4cf}
  .row{display:flex;justify-content:space-between;margin:2px 0}
  .row span:first-child{color:#9fb0bf}
  .badge{background:#b11313;color:#fff;font-weight:800;padding:2px 8px;border-radius:5px;margin-left:8px}
  .btn{border:1px solid #2a3440;border-radius:6px;background:#16202b;color:#e8eef4;padding:4px 8px;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .iss-icon{filter:drop-shadow(0 0 2px #000a)}
</style>
</head>
<body>
<div id="app">
  <header>
    <h1>International Space Station</h1>
    <span class="badge">LIVE</span>
    <span class="stat" id="statusTime">UTC —</span>
    <button class="btn" id="centerBtn">Center ISS</button>
    <label><input type="checkbox" id="unitsToggle"> Imperial units</label>
  </header>
  <div id="map"></div>
</div>

<!-- Floating info panel -->
<div class="panel" id="info">
  <h2>Now</h2>
  <div class="row"><span>Latitude</span><b id="lat">—</b></div>
  <div class="row"><span>Longitude</span><b id="lon">—</b></div>
  <div class="row"><span>Altitude</span><b id="alt">—</b></div>
  <div class="row"><span>Speed</span><b id="vel">—</b></div>
  <div class="row"><span>Sunlight</span><b id="sun">—</b></div>
</div>

<script>
/* -------------------- Config -------------------- */
const WTIA_NOW = 'https://api.wheretheiss.at/v1/satellites/25544';
const WTIA_TLE = 'https://api.wheretheiss.at/v1/satellites/25544/tles';
const TRACK_MINUTES = 90;     // past & future
const TRACK_STEP_SEC = 30;    // point spacing along track
const LIVE_MS = 1000;         // UI refresh
const TLE_REFRESH_MS = 5*60*1000;

let useImperial = false;

/* -------------------- Map -------------------- */
const map = L.map('map', { worldCopyJump:true }).setView([0,0], 3);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 7, minZoom: 2
}).addTo(map);

const term = L.terminator({ resolution: 4, fillOpacity:0.2, color:'#9fb0bf', weight:1 });
term.addTo(map);

setInterval(()=> term.setTime(), 60000); // refresh terminator every minute

/* ISS icon (small SVG) */
const issIcon = L.icon({
  iconUrl: 'data:image/svg+xml;charset=utf8,' + encodeURIComponent(`
    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 64 64">
      <g fill="#ffcc00" stroke="#000" stroke-width="2">
        <rect x="28" y="21" width="8" height="22" rx="1"/>
        <rect x="8" y="26" width="16" height="12" rx="1"/>
        <rect x="40" y="26" width="16" height="12" rx="1"/>
        <rect x="4" y="22" width="4" height="20"/>
        <rect x="56" y="22" width="4" height="20"/>
      </g>
    </svg>`),
  iconSize:[28,28], iconAnchor:[14,14], className:'iss-icon'
});

const issMarker = L.marker([0,0], { icon: issIcon }).addTo(map);
const pastTrack = L.polyline([], { color:'#62b0ff', weight:2, opacity:0.9 }).addTo(map);
const futureTrack = L.polyline([], { color:'#ffaa00', weight:2, opacity:0.9, dashArray:'4,4' }).addTo(map);

/* Controls */
document.getElementById('centerBtn').onclick = ()=> map.setView(issMarker.getLatLng(), map.getZoom());
document.getElementById('unitsToggle').onchange = (e)=> { useImperial = e.target.checked; renderLast(); };

const fmtUTC = (d)=>
  new Intl.DateTimeFormat('en-GB',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false,timeZone:'UTC'}).format(d) + ' UTC';

const round = (v, n=2)=> (Math.round(v*10**n)/10**n).toFixed(n);

/* -------------------- Orbit helpers (satellite.js) -------------------- */
let tle = null, satrec = null, lastNow = null, lastData = null;

async function refreshTLE(){
  const r = await fetch(WTIA_TLE, { cache:'no-store' });
  if(!r.ok) throw new Error('TLE fetch failed');
  const j = await r.json();
  tle = [j.line1, j.line2];
  satrec = satellite.twoline2satrec(tle[0], tle[1]);
}

function propLLA(date){
  const gmst = satellite.gstime(date);
  const pv = satellite.propagate(satrec, date);
  const gd = satellite.eciToGeodetic(pv.position, gmst);
  const lat = satellite.degreesLat(gd.latitude);
  const lon = satellite.degreesLong(gd.longitude);
  const alt = gd.height; // km
  return { lat, lon, alt };
}

function buildTrack(centerDate){
  const ptsPast = [], ptsFuture = [];
  for(let s = -TRACK_MINUTES*60; s <= TRACK_MINUTES*60; s += TRACK_STEP_SEC){
    const d = new Date(centerDate.getTime() + s*1000);
    const {lat,lon} = propLLA(d);
    (s<=0?ptsPast:ptsFuture).push([lat,lon]);
  }
  pastTrack.setLatLngs(ptsPast);
  futureTrack.setLatLngs(ptsFuture);
}

/* -------------------- Live loop -------------------- */
async function getLive(){
  const r = await fetch(WTIA_NOW+'?units=kilometers', { cache:'no-store' });
  if(!r.ok) throw new Error('Live fetch failed');
  return await r.json();
}

function render(data){
  const lat = data.latitude, lon = data.longitude;
  issMarker.setLatLng([lat, lon]);

  const altKm = data.altitude;
  const velKmh = data.velocity;
  const alt = useImperial ? `${round(altKm*0.621371)} mi` : `${round(altKm)} km`;
  const vel = useImperial ? `${round(velKmh*0.621371)} mph` : `${round(velKmh)} km/h`;

  document.getElementById('lat').textContent = `${round(Math.abs(lat),2)} °${lat>=0?'N':'S'}`;
  document.getElementById('lon').textContent = `${round(Math.abs(lon),2)} °${lon>=0?'E':'W'}`;
  document.getElementById('alt').textContent = alt;
  document.getElementById('vel').textContent = vel;
  document.getElementById('sun').textContent = (data.visibility || '').replace(/^\w/, s=>s.toUpperCase());
  document.getElementById('statusTime').textContent = fmtUTC(new Date(data.timestamp*1000));

  lastData = data;
}

function renderLast(){ if(lastData) render(lastData); }

(async function main(){
  try {
    await refreshTLE();
    const now = await getLive();
    lastNow = new Date(now.timestamp*1000);
    // fit map once
    map.setView([now.latitude, now.longitude], 3);
    render(now);
    buildTrack(lastNow);
  } catch (e) {
    console.error(e);
  }

  // Live updates
  setInterval(async ()=>{
    try {
      const d = await getLive();
      lastNow = new Date(d.timestamp*1000);
      render(d);
    } catch(e){ console.error(e); }
  }, LIVE_MS);

  // Rebuild track every few minutes from TLE
  setInterval(async ()=>{
    try{
      await refreshTLE();
      buildTrack(new Date());
    }catch(e){ console.error(e); }
  }, TLE_REFRESH_MS);
})();
</script>

<!-- Data sources: WhereTheISSAt API (position, velocity, altitude) and TLE; 
     Leaflet + Leaflet.Terminator; satellite.js (SGP4 propagation). -->
</body>
</html>
