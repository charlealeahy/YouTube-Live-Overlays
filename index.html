<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ISS Info Widget</title>
<style>
  :root{
    --w: 560px;
    --gap: 14px;
    --bg: #0e161c;
    --panel: #111b23;
    --ink: #e8f1f8;
    --muted:#8fa6b6;
    --accent:#4db2ff;
    --card:#0c141a;
    --pill:#c92c2c;
    --shadow: 0 10px 26px rgba(0,0,0,.45);
    --r:18px;
  }
  html,body{height:100%;margin:0;background:#0b1318;color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  *{box-sizing:border-box}
  .widget{width:var(--w);margin:26px; padding:18px;border-radius:calc(var(--r)+6px);
    background:linear-gradient(180deg,#0f1820,#0a1217); box-shadow:var(--shadow)}
  .title{display:flex;justify-content:center;align-items:center;
    border-radius:var(--r); background:var(--panel); padding:14px 18px;
    font-weight:700; font-size:26px; letter-spacing:.3px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  /* main row uses equal heights for left + right, so the card never extends below LIVE */
  .row{margin-top:12px; display:grid; grid-template-columns:120px 1fr; gap:var(--gap); align-items:stretch;}
  .side{background:var(--panel); border-radius:var(--r); padding:14px;
        display:flex; flex-direction:column; justify-content:space-between; align-items:center}
  .flag{width:92px;height:64px; border-radius:10px; object-fit:cover; display:block}
  .live{margin-top:16px; background:var(--pill); color:#fff; font-weight:800; font-size:16px;
        padding:9px 16px; border-radius:999px; text-align:center; min-width:72px; box-shadow:0 2px 6px rgba(0,0,0,.35)}
  .card{background:var(--panel); border-radius:var(--r); padding:16px 18px; display:flex; flex-direction:column}
  .sectionTitle{font-weight:700; margin-bottom:10px}
  .grid{display:grid; grid-template-columns:auto 1fr; column-gap:14px; row-gap:10px; align-content:start}
  .label{color:var(--muted)}
  .val{font-variant-numeric:tabular-nums}
  .progress{height:6px; width:100%; margin-top:auto; background:#0a1015; border-radius:7px; overflow:hidden}
  .bar{height:100%; width:0%; background:linear-gradient(90deg,#79c9ff,var(--accent)); transition:width .2s linear}
  .hide{display:none !important}
  /* small screens */
  @media (max-width:640px){ :root{--w: 96vw} .title{font-size:22px} }
</style>
</head>
<body>
  <div class="widget" id="w">
    <div class="title" id="title">—</div>

    <div class="row">
      <div class="side">
        <img id="flag" class="flag" alt="Flag"/>
        <div class="live" id="livePill">LIVE</div>
      </div>

      <div class="card">
        <div class="sectionTitle" id="cardTitle">—</div>
        <div class="grid" id="grid"></div>
        <div class="progress" id="prog"><div class="bar" id="bar"></div></div>
      </div>
    </div>
  </div>

<script>
const API = "https://iss-live.charlesleahy.workers.dev";

/* -------- helpers -------- */
const $ = s => document.querySelector(s);
const titleEl = $('#title'), flagEl = $('#flag'), gridEl = $('#grid'),
      cardTitle = $('#cardTitle'), barEl = $('#bar'), progEl = $('#prog');

const fmtInt  = n => (n??"—").toLocaleString('en-US');
const fmt1    = n => (n==null? "—" : (Math.round(n*10)/10).toLocaleString('en-US'));
const pad2    = n => String(n).padStart(2,'0');
const utcNow  = () => { const d=new Date();
  return `${pad2(d.getUTCHours())}:${pad2(d.getUTCMinutes())}:${pad2(d.getUTCSeconds())}`; };

function wavesSVG(){
  // inline ocean icon, no borders, always available
  return `data:image/svg+xml;utf8,
  <svg xmlns='http://www.w3.org/2000/svg' width='92' height='64' viewBox='0 0 92 64'>
    <defs><linearGradient id='g' x1='0' x2='0' y1='0' y2='1'>
      <stop offset='0%' stop-color='%232f7cb6'/><stop offset='100%' stop-color='%231a4a73'/></linearGradient></defs>
    <rect rx='10' ry='10' width='92' height='64' fill='url(%23g)'/>
    <g fill='none' stroke='%23bfe5ff' stroke-width='5' stroke-linecap='round'>
      <path d='M10 26c8 8 16 8 24 0s16-8 24 0 16 8 24 0'/>
      <path d='M10 42c8 8 16 8 24 0s16-8 24 0 16 8 24 0'/>
    </g>
  </svg>`.replace(/\n|\s{2,}/g,' ');
}

function flagURL(iso2){
  return `https://flagcdn.com/w80/${iso2.toLowerCase()}.png`;
}

/* -------- rendering -------- */
function setHeader(place){
  const name = place.ocean
    ? place.ocean
    : `${place.region ? place.region + ', ' : ''}${place.country || ''}`.trim().replace(/^,\s*/,'');
  titleEl.textContent = name || '—';
}

function setFlag(place){
  if (place.ocean) { flagEl.src = wavesSVG(); flagEl.alt = "Ocean"; }
  else if (place.iso2) { flagEl.src = flagURL(place.iso2); flagEl.alt = place.iso2; }
  else { flagEl.src = wavesSVG(); flagEl.alt = "—"; }
}

/* slides: stats, country, life (life+age) */
function renderStats(state, place){
  cardTitle.textContent = "Now";
  gridEl.innerHTML = "";
  addRow("UTC :", utcNow() + " UTC");
  addRow("Date :", new Date().toISOString().slice(0,10));
  addRow("Speed :", fmt1(state.speed_kps) + " km/s");
  addRow("Elev :", fmtInt(state.alt_km) + " km");
}
function renderCountry(state, place, facts){
  cardTitle.textContent = "Country Information";
  gridEl.innerHTML = "";
  addRow("Capital :", facts.capital ?? "—");
  addRow("Density :", facts.density ?? "—");
  addRow("Poverty :", facts.poverty ?? "—");
}
function renderLife(state, place, factsLife){
  cardTitle.textContent = "Life & Age";
  gridEl.innerHTML = "";
  addRow("Life Expectancy :", factsLife.life ?? "—");
  addRow("Median Age :", factsLife.median ?? "—");
  addRow("Male :", factsLife.male ?? "—");
  addRow("Female :", factsLife.female ?? "—");
}
function addRow(label, value){
  const l = document.createElement('div'); l.className="label"; l.textContent = label;
  const v = document.createElement('div'); v.className="val";   v.textContent = value ?? "—";
  gridEl.appendChild(l); gridEl.appendChild(v);
}

/* -------- slider control -------- */
let slides=[], slideIdx=0, tick=null, progTimer=null, secondsPer=7;

function buildSlides(place, facts, factsLife){
  const arr = [{name:"stats", fn:()=>renderStats(lastState, place)}];
  if (!place.ocean){
    arr.push({name:"country", fn:()=>renderCountry(lastState, place, facts)});
    arr.push({name:"life",    fn:()=>renderLife(lastState, place, factsLife)});
  }
  return arr;
}

function startSlider(){
  stopSlider();
  if (slides.length<=1){
    progEl.classList.add('hide');
    slides[0]?.fn();
    return;
  }
  progEl.classList.remove('hide');
  slideIdx = 0;
  nextSlide();
  tick = setInterval(nextSlide, secondsPer*1000);
  // animate progress bar
  let t=0;
  progTimer = setInterval(()=>{
    t = (t + 0.2); // 200ms steps
    const frac = (t % (secondsPer*5)) / (secondsPer*5); // keep numbers modest
    const within = (t % secondsPer) / secondsPer;
    barEl.style.width = (within*100).toFixed(1)+"%";
  },200);
}
function nextSlide(){
  slides[slideIdx].fn();
  slideIdx = (slideIdx+1) % slides.length;
}
function stopSlider(){
  clearInterval(tick); clearInterval(progTimer);
  barEl.style.width = '0%';
}

/* -------- data polling -------- */
let lastState=null, lastPlace=null, lastIso=null;

async function getJSON(u, timeout=8000){
  const ctl = new AbortController(); const id=setTimeout(()=>ctl.abort(), timeout);
  try{ const r=await fetch(u,{signal:ctl.signal, headers:{'user-agent':'iss-overlay-widget'}}); if(!r.ok) throw new Error(r.status); return await r.json(); }
  finally{ clearTimeout(id); }
}

async function refresh(){
  try{
    const iss = await getJSON(`${API}/iss`);
    lastState = iss;

    const rg = await getJSON(`${API}/rg?lat=${iss.lat}&lon=${iss.lon}`);
    lastPlace = rg;

    // fetch facts when on land (iso2 present)
    let facts={}, life={};
    if (rg.iso2){
      facts = await getJSON(`${API}/facts?iso2=${rg.iso2}`).catch(()=>({}));
      // Life/Age values – if your worker adds them later, they’ll show; otherwise we keep "—"
      life  = {
        life:  facts.life  ?? "—",
        male:  facts.male  ?? "—",
        female:facts.female?? "—",
        median:facts.median?? "—"
      };
    }

    setHeader(rg);
    setFlag(rg);

    // rebuild slides only if land/ocean changed or iso changed
    const key = (rg.ocean?("ocean:"+rg.ocean):("land:"+rg.iso2||""));
    if (key !== lastIso){
      lastIso = key;
      slides = buildSlides(rg, facts, life);
      startSlider();
    } else {
      // still update current slide (UTC ticks, alt/speed drift)
      slides[ (slideIdx+slides.length-1)%slides.length ].fn();
    }

  }catch(e){
    titleEl.textContent = "Network error – retrying…";
  }
}

/* update UTC clock in-place without rebuilding grid */
setInterval(()=>{
  if (!gridEl.children.length) return;
  // find the first label cell that equals "UTC :" and update its value cell
  for (let i=0;i<gridEl.children.length;i+=2){
    if (gridEl.children[i].textContent.startsWith("UTC")){
      gridEl.children[i+1].textContent = utcNow()+" UTC";
      break;
    }
  }
},1000);

/* poll fresh data frequently so location updates without reload */
refresh();
setInterval(refresh, 10000); // every 10s
</script>
</body>
</html>
