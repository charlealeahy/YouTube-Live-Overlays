<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ISS Info Widget</title>
<!-- SunCalc for sunrise/sunset -->
<script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>
<!-- satellite.js for SGP4 (local orbit fallback) -->
<script src="https://cdn.jsdelivr.net/npm/satellite.js@5.0.1/dist/satellite.min.js"></script>
<style>
  :root{ --w:440px; --h:240px; --bg:#0e0f12; --panel:#171a1f; --muted:#9aa4b2; --text:#e7edf5; --card:#101319; }
  html,body{height:100%;margin:0;background:transparent}
  *{box-sizing:border-box;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .widget{width:var(--w);height:var(--h);display:grid;grid-template-rows:1fr 84px;gap:8px;padding:8px;background:var(--bg);color:var(--text);border:1px solid #262a34;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.45);overflow:hidden}
  /* Two-line heading */
  .location{display:grid;place-items:center;grid-template-rows:auto auto;row-gap:2px;background:linear-gradient(180deg,#12151c,#0e1116);border-radius:10px;border:1px solid #1e2530;padding:10px}
  .locLine{font-weight:700;letter-spacing:.3px;text-align:center;line-height:1.05}
  .locTop{font-size:30px}.locBottom{font-size:26px;opacity:.95}
  .location.small .locTop{font-size:26px}.location.small .locBottom{font-size:22px}
  .location.tiny .locTop{font-size:22px}.location.tiny .locBottom{font-size:19px}
  .bottom{display:grid;grid-template-columns:112px 1fr;gap:8px}
  .flagCard{background:var(--card);border:1px solid #1f2430;border-radius:10px;display:grid;grid-template-rows:1fr 24px;overflow:hidden}
  .flagWrap{display:flex;align-items:center;justify-content:center;padding:8px;background:radial-gradient(120% 140% at 50% 0%,#1a2230 0%,#0f141d 60%,#0b0e13 100%)}
  .flag{width:100%;height:100%;max-width:88px;max-height:60px;object-fit:cover;border-radius:6px;border:1px solid #2a3140;background:#0b0d10}
  .live{background:#c61717;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:900;letter-spacing:.6px;text-transform:uppercase;font-size:12px}
  .info{background:var(--panel);border:1px solid #222937;border-radius:10px;padding:8px 10px;display:grid;grid-template-rows:auto 1fr;gap:6px}
  .rowTitle{font-weight:800;color:#cfd7e3;font-size:16px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:4px 14px;font-size:13px;line-height:1.3;align-content:start}
  .muted{color:var(--muted)} .mono{font-variant-numeric:tabular-nums;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .span2{grid-column:1 / -1;text-align:center}
</style>
</head>
<body>
<div class="widget">
  <div class="location" id="loc">
    <div id="locTop" class="locLine locTop">—</div>
    <div id="locBottom" class="locLine locBottom">—</div>
  </div>

  <div class="bottom">
    <div class="flagCard">
      <div class="flagWrap"><img id="flag" class="flag" alt="Flag"/></div>
      <div class="live">LIVE</div>
    </div>

    <div class="info">
      <div class="rowTitle" id="eventTitle">Next: —</div>
      <div class="grid">
        <div><span class="muted">UTC:</span>   <span class="mono" id="utc">—</span></div>
        <div><span class="muted">Date:</span>  <span class="mono" id="date">—</span></div>
        <div><span class="muted">Speed:</span> <span class="mono" id="speed">—</span></div>
        <div><span class="muted">Elev:</span>  <span class="mono" id="alt">—</span></div>
        <div><span class="muted">Density:</span> <span class="mono" id="density">—</span></div>
        <div><span class="muted">Poverty:</span> <span class="mono" id="poverty">—</span></div>
        <div class="span2"><span class="muted">Capital:</span> <span class="mono" id="capital">—</span></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== settings ===== */
const REFRESH_MS = 5000;
const TEXT1 = 26, TEXT2 = 40;

/* ===== helpers ===== */
const el = id => document.getElementById(id);
const fmt  = new Intl.NumberFormat('en-US',{maximumFractionDigits:2});
const fmt3 = new Intl.NumberFormat('en-US',{maximumFractionDigits:3});
const pct  = x => (x==null||isNaN(x)?'—':(Math.round(x*10)/10).toFixed(1)+'%');

function fitTwoLine(top,bottom){
  const box = el('loc'); box.classList.remove('small','tiny');
  el('locTop').textContent = top || '—';
  el('locBottom').textContent = bottom || '—';
  const total = (top||'').length + (bottom||'').length;
  if(total > TEXT1 && total <= TEXT2) box.classList.add('small');
  if(total > TEXT2) box.classList.add('tiny');
}

async function getText(url,{timeout=7000,retries=1}={}) {
  for(let a=0;a<=retries;a++){
    try{
      const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(),timeout);
      const r=await fetch(url,{signal:ctrl.signal,cache:'no-store'}); clearTimeout(t);
      if(r.ok) return await r.text();
    }catch(e){}
    await new Promise(r=>setTimeout(r,400+a*300));
  }
  throw new Error('text fetch failed '+url);
}
async function getJSON(url,opts){ return JSON.parse(await getText(url,opts)); }

/* ---------- ISS position with multiple fallbacks ---------- */
async function getISS(){
  const ts = Date.now();
  // 1) WhereTheISS
  try{ return await getJSON(`https://api.wheretheiss.at/v1/satellites/25544?ts=${ts}`, {timeout:6000,retries:1}); }catch(e){}
  // 2) Open-Notify (via simple CORS proxy)
  try{
    const on = await getJSON(`https://cors.isomorphic-git.org/https://api.open-notify.org/iss-now.json`, {timeout:6000});
    return {
      latitude:  parseFloat(on?.iss_position?.latitude),
      longitude: parseFloat(on?.iss_position?.longitude),
      altitude:  undefined,                // will fill from SGP4 fallback
      velocity:  undefined
    };
  }catch(e){}
  // 3) Local SGP4 using fresh TLE via text proxy (always works)
  try{
    const tleTxt = await getText('https://r.jina.ai/https://celestrak.org/NORAD/elements/stations.txt', {timeout:7000});
    const lines = tleTxt.split(/\r?\n/);
    const idx = lines.findIndex(l=>/^ISS \(ZARYA\)/i.test(l));
    const tle1 = lines[idx+1]?.trim();
    const tle2 = lines[idx+2]?.trim();
    if(tle1 && tle2 && window.satellite){
      const satrec = satellite.twoline2satrec(tle1, tle2);
      const now = new Date();
      const pv = satellite.propagate(satrec, now);
      const gmst = satellite.gstime(now);
      const gd = satellite.eciToGeodetic(pv.position, gmst);
      const lat = satellite.degreesLat(gd.latitude);
      const lon = satellite.degreesLong(gd.longitude);
      const altKm = gd.height; // km
      // speed magnitude from km/s vector
      const v = pv.velocity;
      const speedKps = Math.sqrt(v.x*v.x + v.y*v.y + v.z*v.z); // km/s
      return { latitude: lat, longitude: lon, altitude: altKm, velocity: speedKps*3600 /* to km/h to match primary */ };
    }
  }catch(e){}
  throw new Error('All ISS sources failed');
}

/* ---------- Reverse geocode (reliable chain, no keys) ---------- */
async function reverseGeocode(lat, lon){
  // Open-Meteo (fast, CORS OK)
  try{
    const j = await getJSON(`https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&language=en`);
    const r = j?.results?.[0];
    if(r){ return {countryName:r.country||null, iso2:(r.country_code||'').toUpperCase()||null, region:r.admin1||r.admin2||r.name||null, oceanName:null}; }
  }catch(e){}
  // BigDataCloud (ocean detection)
  try{
    const j = await getJSON(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`);
    let ocean=null; const inf=j?.localityInfo?.informative||[]; const o=inf.find(x=>/ocean/i.test(x.description||x.name||'')); if(o) ocean=o.name||o.description;
    if(j.countryName || ocean){ return {countryName:j.countryName||null, iso2:j.countryCode||null, region:j.principalSubdivision||j.locality||null, oceanName:ocean}; }
  }catch(e){}
  // maps.co (Nominatim mirror)
  try{
    const j = await getJSON(`https://geocode.maps.co/reverse?lat=${lat}&lon=${lon}`); const a=j.address||{};
    return {countryName:a.country||null, iso2:(a.country_code||'').toUpperCase()||null, region:a.state||a.county||a.region||null, oceanName:a.ocean||a.water||null};
  }catch(e){}
  // OSM direct
  try{
    const j = await getJSON(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`); const a=j.address||{};
    return {countryName:a.country||null, iso2:(a.country_code||'').toUpperCase()||null, region:a.state||a.county||a.region||null, oceanName:a.ocean||a.water||null};
  }catch(e){}
  return {countryName:null, iso2:null, region:null, oceanName:null};
}

/* Next sunrise/sunset across today+tomorrow */
function nextSunEvent(lat, lon, now){
  const evts=[]; for(let d=0; d<2; d++){ const day=new Date(now.getTime()+d*86400000); const t=SunCalc.getTimes(day,lat,lon); evts.push({name:'Sunrise',t:t.sunrise},{name:'Sunset',t:t.sunset}); }
  return evts.filter(e=>e.t && e.t>now).sort((a,b)=>a.t-b.t)[0] || null;
}

/* Persist last good state so UI never blanks */
let last = {lat:null, lon:null, altKm:null, speedKps:null, iso2:null, country:null, region:null};

async function tick(){
  try{
    // 1) ISS position (with fallbacks including SGP4)
    const iss = await getISS();
    const lat = Number(iss.latitude), lon = Number(iss.longitude);
    const altKm = Number(iss.altitude), speedKps = Number(iss.velocity)/3600;

    if(!Number.isNaN(lat) && !Number.isNaN(lon)){ last.lat=lat; last.lon=lon; }
    if(!Number.isNaN(altKm)) { last.altKm=altKm; }
    if(!Number.isNaN(speedKps)) { last.speedKps=speedKps; }

    const useLat=last.lat, useLon=last.lon;

    // 2) Reverse geocode
    let place = {countryName:last.country, iso2:last.iso2, region:last.region, oceanName:null};
    if(useLat!=null && useLon!=null){
      place = await reverseGeocode(useLat, useLon);
      last.country=place.countryName; last.iso2=place.iso2; last.region=place.region;
    }

    // 3) Two-line heading
    const overOcean = !place.countryName && !!place.oceanName;
    if(overOcean){ fitTwoLine(place.oceanName || 'Open Ocean', ''); }
    else if(place.region && place.countryName){ fitTwoLine(place.region, place.countryName); }
    else { fitTwoLine(place.countryName || '—', ''); }

    // 4) Flag
    const flagEl = el('flag');
    if(place.iso2){ flagEl.src=`https://flagcdn.com/w80/${place.iso2.toLowerCase()}.png`; flagEl.style.opacity='1'; }
    else { flagEl.removeAttribute('src'); flagEl.style.opacity='0.25'; }

    // 5) Next sun event
    const now=new Date(); const next=(useLat!=null&&useLon!=null)? nextSunEvent(useLat,useLon,now):null;
    const pad=n=>String(n).padStart(2,'0'); const toUTCDate=d=>`${d.getUTCFullYear()}-${pad(d.getUTCMonth()+1)}-${pad(d.getUTCDate())}`; const toUTCTime=d=>`${pad(d.getUTCHours())}:${pad(d.getUTCMinutes())}:${pad(d.getUTCSeconds())}`;
    if(next){ el('eventTitle').textContent=`Next: ${next.name}`; el('utc').textContent=`${toUTCTime(next.t)} UTC`; el('date').textContent=toUTCDate(next.t); }
    else { el('eventTitle').textContent='Next: —'; el('utc').textContent=`${toUTCTime(now)} UTC`; el('date').textContent=toUTCDate(now); }

    // 6) Numbers
    el('speed').textContent = (last.speedKps!=null? fmt3.format(last.speedKps)+' km/s' : '—');
    el('alt').textContent   = (last.altKm!=null? fmt.format(last.altKm)+' km' : '—');

    // 7) Country facts
    let capital='—', density='—', population=null, area=null;
    if(place.iso2){
      try{
        const rest = await getJSON(`https://restcountries.com/v3.1/alpha/${place.iso2}`);
        const r = Array.isArray(rest)?rest[0]:rest;
        capital = (r && r.capital && r.capital[0]) ? r.capital[0] : '—';
        population = r?.population || null; area = r?.area || null;
        if(population && area){ density = `${fmt.format(population/area)} ppl/km²`; }
      }catch(e){}
    }
    el('capital').textContent = capital;
    el('density').textContent = density;

    // 8) Poverty
    let pov='—';
    if(place.iso2){
      try{
        const wb = await getJSON(`https://api.worldbank.org/v2/country/${place.iso2}/indicator/SI.POV.DDAY?format=json&per_page=60`);
        const series = (wb && wb[1]) ? wb[1] : []; const latest = series.find(x=>x.value!==null);
        if(latest && typeof latest.value === 'number'){ pov = pct(latest.value); }
      }catch(e){}
    }
    el('poverty').textContent = pov;

  }catch(err){ console.error(err); }
}

/* Live UTC labels */
function tickClock(){
  const now = new Date();
  const pad=n=>String(n).padStart(2,'0');
  el('date').textContent = `${now.getUTCFullYear()}-${pad(now.getUTCMonth()+1)}-${pad(now.getUTCDate())}`;
  el('utc').textContent  = `${pad(now.getUTCHours())}:${pad(now.getUTCMinutes())}:${pad(now.getUTCSeconds())} UTC`;
}

tick();
setInterval(tick, REFRESH_MS);
setInterval(tickClock, 1000);
</script>
</body>
</html>
