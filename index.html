<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ISS Info Widget</title>

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
:root{
  --w: 560px;                 /* widget width */
  --pad: 12px;                /* panel padding */
  --bg: #0e1116;              /* page bg */
  --panel: #121a22;           /* panel bg */
  --panel2: #0c141c;          /* outer shell bg */
  --muted: #8aa4bd;
  --text: #e9f2ff;
  --acc: #3aa0ff;
  --shadow: 0 24px 48px rgba(0,0,0,.35);
  --radius: 16px;

  /* left column sizing (flag + LIVE); this drives the total row height */
  --flagH: 76px;
  --flagW: 114px;
  --liveH: 36px;
  --colGap: 12px;
  --rowH: calc(var(--flagH) + var(--liveH) + var(--colGap) + var(--pad)*2);
}

/* Page */
html,body{
  height:100%;
  margin:0;
  background:#0a0f14; /* subtle darker than panel */
  background:
    radial-gradient(1200px 800px at -200px -200px, #071019 0%, #050a11 35%, #04070c 55%, #02060b 80%, #010409 100%),
    var(--bg);
  font-family: Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  color:var(--text);
}

/* Widget shell */
.widget{
  width:var(--w);
  margin:28px;
  padding:14px;
  background:var(--panel2);
  border-radius: calc(var(--radius) + 4px);
  box-shadow: var(--shadow);
}

/* Title bar */
.title{
  height:56px;
  display:flex;
  align-items:center;
  justify-content:center;   /* centered as requested */
  background:
    linear-gradient(180deg, #0f1b26, #0d131a);
  border-radius: var(--radius);
  font-weight:800;
  font-size:26px;
  letter-spacing:.3px;
  text-shadow: 0 1px 0 #000;
  margin-bottom:12px;
}

/* Main row: left badge + right info (their heights are locked together) */
.row{
  display:grid;
  grid-template-columns: minmax(120px, 130px) 1fr;
  column-gap:12px;
  align-items:start;
}

/* Left column (flag + LIVE) */
.badge{
  height: var(--rowH);                /* <-- fixes the total row height anchor */
  background:var(--panel);
  border-radius: var(--radius);
  padding: var(--pad);
  display:grid;
  grid-template-rows: var(--flagH) var(--liveH);
  row-gap: var(--colGap);
  align-items:start;
}

/* Flag image (no border) */
.flag{
  width:var(--flagW);
  height:var(--flagH);
  object-fit: cover;                  /* neat edges */
  border-radius: 10px;                /* softer */
  display:block;
}

/* LIVE badge */
.live{
  height:var(--liveH);
  display:inline-grid;
  place-items:center;
  padding: 0 18px;
  border-radius: 10px;
  background: linear-gradient(0deg, #b51316, #e21f25);
  color:#fff;
  font-weight:800;
  text-shadow: 0 1px 0 rgba(0,0,0,.4);
  box-shadow: inset 0 -2px 0 rgba(0,0,0,.25);
  width:max-content;
}

/* Right column (info) – height locked to left by JS, but we also clamp */
.info{
  background: var(--panel);
  border-radius: var(--radius);
  padding: var(--pad);
  overflow:hidden;                    /* never drop below LIVE bottom visually */
  position:relative;
  height: var(--rowH);                /* initial clamp; JS will re-fit precisely */
}

/* Two-line grid inside info */
.grid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:12px 18px;
  align-content:start;
}

/* Labels */
.k{ color: var(--muted); }
.v{ font-weight: 700; }

/* Progress bar for slide timing */
.progress{
  position:absolute; left:12px; right:12px; bottom:10px; height:6px;
  border-radius:6px; background:#0b1924;
  overflow:hidden;
}
.progress > i{
  display:block; height:100%; width:0%;
  background: linear-gradient(90deg, #61c3ff, #2aa3ff);
}

/* Section heading */
.h{
  grid-column: 1 / -1;
  font-weight: 800;
  color: #b8d6ff;
  margin-top:4px;
}

/* Small */
small{ color:var(--muted); }

/* Subtle separator line (for life slide) */
.sep{
  grid-column: 1 / -1;
  height:1px; background:rgba(255,255,255,.06);
  margin-top:4px;
}
</style>
</head>
<body>

<div class="widget">
  <div id="title" class="title">—</div>

  <div class="row">
    <div class="badge">
      <img id="flag" class="flag" alt="Flag" src="" />
      <div class="live">LIVE</div>
    </div>

    <div id="info" class="info">
      <div id="slide" class="grid"></div>
      <div class="progress"><i id="bar"></i></div>
    </div>
  </div>
</div>

<script>
/* ---------- config ---------- */
const API = 'https://iss-live.charlesleahy.workers.dev';
const UPDATE_MS = 8000;            // how often to refresh ISS/region
const SLIDE_MS  = 4500;            // slide duration
const LIFE_FIRST = true;           // start on life/age first if available

/* ---------- elements ---------- */
const el = {
  title:  document.getElementById('title'),
  flag:   document.getElementById('flag'),
  info:   document.getElementById('info'),
  slide:  document.getElementById('slide'),
  bar:    document.getElementById('bar'),
};

/* ---------- helpers ---------- */
const fmt = n => n.toLocaleString('en-US');
const km  = n => `${fmt(n)} km`;
const kps = n => `${n.toFixed(2)} km/s`;
const utc = () => new Date().toISOString().slice(11,19) + ' UTC';
const today = () => new Date().toISOString().slice(0,10);

function setFlag(iso2, ocean){
  if (ocean){
    // ocean icon (no border)
    el.flag.src = "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f30a.svg";
  }else{
    const code = (iso2||'XX').toLowerCase();
    el.flag.src = `https://flagcdn.com/w160/${code}.png`;
  }
}

/* build simple key/value row */
function row(k, v){
  const wrap = document.createElement('div');
  const kEl = document.createElement('div');
  const vEl = document.createElement('div');
  wrap.style.display = 'contents';
  kEl.className = 'k';
  vEl.className = 'v';
  kEl.textContent = k + ' :';
  vEl.textContent = (v ?? '—');
  wrap.appendChild(kEl); wrap.appendChild(vEl);
  return wrap;
}

/* clamps right panel height to badge column (keeps bottom aligned to LIVE) */
function fitHeights(){
  const badge = document.querySelector('.badge');
  const h = badge.getBoundingClientRect().height;
  el.info.style.height = Math.round(h) + 'px';
}

/* ---------- slides ---------- */
let slideIx = 0;
let slideTimer, progTimer;
let slides = [];  // each slide: {name, build(dom)}

function startSlides(){
  clearInterval(slideTimer);
  clearInterval(progTimer);
  slideIx = 0;
  runSlide();
  slideTimer = setInterval(nextSlide, SLIDE_MS);
  animateProgress();
}
function nextSlide(){
  slideIx = (slideIx + 1) % slides.length;
  runSlide();
  animateProgress();
}
function runSlide(){
  el.slide.innerHTML = '';
  const s = slides[slideIx];
  s.build(el.slide);
  fitHeights(); // keep aligned after slide content changes
}
function animateProgress(){
  el.bar.style.transition = 'none';
  el.bar.style.width = '0%';
  // force reflow
  void el.bar.offsetWidth;
  el.bar.style.transition = `width ${SLIDE_MS}ms linear`;
  el.bar.style.width = '100%';
}

/* ---------- data loop ---------- */
let last = {lat:0, lon:0, alt_km:0, speed_kps:0};
let region = {country:null, iso2:null, region:null, ocean:null};
let facts  = {capital:'—', density:'—', poverty:'—'};
let life   = {life:'—', male:'—', female:'—', median:'—'};

async function getJSON(u, timeout=7000){
  const ctl = new AbortController();
  const t = setTimeout(() => ctl.abort(), timeout);
  try{
    const res = await fetch(u + (u.includes('?')?'&':'?') + 't=' + Date.now(), {
      cache: 'no-store', signal: ctl.signal,
      headers: {'user-agent':'iss-overlay'}
    });
    if(!res.ok) throw new Error(res.status);
    return res.json();
  } finally { clearTimeout(t); }
}

async function refresh(){
  // 1) ISS position
  try{
    last = await getJSON(`${API}/iss`);
  }catch(e){ /* ignore transient */ }

  // 2) Reverse geocode -> region/ocean
  try{
    region = await getJSON(`${API}/rg?lat=${last.lat}&lon=${last.lon}`);
  }catch(e){ /* ignore */ }

  // 3) country stats (only if on land)
  try{
    if(region.iso2){
      facts = await getJSON(`${API}/facts?iso2=${region.iso2}`);
    }else{
      facts = {capital:'—', density:'—', poverty:'—'};
    }
  }catch(e){ /* ignore */ }

  // 4) (optional) life stats source placeholder; keep '—' if unknown
  // if you add a life endpoint, put it here and fill "life" object

  render();
}

function render(){
  // Title (centered)
  let title = region.ocean ? region.ocean : (region.region ? `${region.region}, ${region.country}` : '—');
  el.title.textContent = title;

  // Flag / ocean icon
  setFlag(region.iso2, !!region.ocean);

  // Slide set
  slides = [
    {
      name:'telemetry',
      build: (dom)=>{
        const g = dom;
        g.appendChild(row('UTC', utc()));
        g.appendChild(row('Date', today()));
        g.appendChild(row('Speed', kps(last.speed_kps||7.66)));
        g.appendChild(row('Elev', km(Math.round(last.alt_km||420))));
      }
    },
    {
      name:'country',
      build: (dom)=>{
        const h = document.createElement('div'); h.className = 'h'; h.textContent = 'Country Information';
        dom.appendChild(h);
        dom.appendChild(row('Capital', facts.capital ?? '—'));
        dom.appendChild(row('Density', facts.density ?? '—'));
        dom.appendChild(row('Poverty', facts.poverty ?? '—'));
      }
    },
    {
      name:'life',
      build: (dom)=>{
        const h = document.createElement('div'); h.className = 'h'; h.textContent = 'Life & Age';
        dom.appendChild(h);
        dom.appendChild(row('Life Expectancy', life.life));
        dom.appendChild(row('Median Age', life.median));
        dom.appendChild(row('Male', life.male));
        dom.appendChild(row('Female', life.female));
      }
    }
  ];

  // put life first if desired
  if (LIFE_FIRST) slides = [slides[2], slides[0], slides[1]];
  startSlides();
}

/* ---------- intervals ---------- */
addEventListener('resize', fitHeights);
addEventListener('load', () => {
  fitHeights();
  refresh();
  setInterval(refresh, UPDATE_MS); // location updates without reload
});
</script>
</body>
</html>
