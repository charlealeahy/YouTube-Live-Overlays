<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ISS Info Widget</title>
<link rel="preconnect" href="https://flagcdn.com">
<style>
  :root{
    --bg:#0e161c;
    --panel:#0f1b23;
    --card:#0b151c;
    --muted:#8aa9c6;
    --text:#e9f3ff;
    --accent:#4db2ff;
    --shadow:0 14px 40px rgba(0,0,0,.45);
    --radius:18px;
  }
  html,body{height:100%;margin:0;background:#0a1218;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--text)}
  *{box-sizing:border-box}
  .wrap{padding:18px}
  .widget{
    width: 560px; max-width: 96vw;
    background: linear-gradient(180deg,#101b24,#0c151b);
    border: 1px solid #0b2433;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 18px 18px 16px 18px;
  }
  .title{
    display:grid; place-items:center;
    height:64px;
    background: radial-gradient(120% 120% at -10% -20%,#0e2230 0,#0c151b 60%);
    border:1px solid #123246;
    border-radius: 14px;
    font-weight: 800; letter-spacing:.3px; font-size:28px;
  }
  .row{
    margin-top:14px;
    display:grid; grid-template-columns:118px 1fr; gap:14px;
  }
  .flagBox{
    background: var(--card);
    border:1px solid #122738;
    border-radius: 14px;
    padding: 12px 12px 56px 12px; /* leave room for LIVE badge */
    position: relative;
    display:grid; place-items:center;
    min-height: 136px;
  }
  .flag{
    width: 88px; height: 58px; object-fit: cover; border-radius: 8px;
    display:block;
  }
  .live{
    position:absolute; left:12px; bottom:12px;
    background:linear-gradient(#e22,#a40);
    border-radius: 12px; padding:7px 14px;
    font-weight:800; color:#fff; letter-spacing:.6px;
    border:1px solid rgba(0,0,0,.35); box-shadow: 0 6px 20px rgba(0,0,0,.35);
    text-transform: uppercase; font-size:14px;
    display:flex; align-items:center; gap:8px;
  }
  .dot{width:8px;height:8px;background:#fff;border-radius:999px;box-shadow:0 0 10px #fff}
  .card{
    background: var(--card);
    border:1px solid #122738;
    border-radius: 14px;
    padding: 16px 18px;
    display:grid; gap:10px;
    min-height: 136px;
  }
  .kv{
    display:grid; grid-template-columns:120px 1fr; align-items:baseline;
    font-size:16px; line-height:1.15;
  }
  .k{color:var(--muted)}
  .v{font-weight:700}
</style>
</head>
<body>
  <div class="wrap">
    <div class="widget" id="widget">
      <div class="title" id="place">—</div>

      <div class="row">
        <div class="flagBox">
          <img id="flag" class="flag" alt="Flag / Photo" />
          <div class="live"><span class="dot"></span>LIVE</div>
        </div>

        <div class="card" id="now">
          <div class="kv"><div class="k">UTC :</div>   <div class="v" id="utc">—</div></div>
          <div class="kv"><div class="k">Date :</div>  <div class="v" id="date">—</div></div>
          <div class="kv"><div class="k">Speed :</div> <div class="v" id="speed">—</div></div>
          <div class="kv"><div class="k">Elev :</div>  <div class="v" id="alt">—</div></div>
        </div>
      </div>
    </div>
  </div>

<script>
const API = "https://iss-live.charlesleahy.workers.dev";
const els = {
  place: document.getElementById('place'),
  flag:  document.getElementById('flag'),
  utc:   document.getElementById('utc'),
  date:  document.getElementById('date'),
  speed: document.getElementById('speed'),
  alt:   document.getElementById('alt'),
};

// curated ocean photos (stable links)
const OCEAN_IMG = {
  "Pacific Ocean": "https://upload.wikimedia.org/wikipedia/commons/thumb/1/15/Pacific_Ocean_-_Fiji_%28Unsplash%29.jpg/512px-Pacific_Ocean_-_Fiji_%28Unsplash%29.jpg",
  "Atlantic Ocean": "https://upload.wikimedia.org/wikipedia/commons/thumb/2/20/Atlantic_Ocean_view_from_madeira.jpg/512px-Atlantic_Ocean_view_from_madeira.jpg",
  "Indian Ocean": "https://upload.wikimedia.org/wikipedia/commons/thumb/9/9a/Indian_Ocean_Maldives.jpg/512px-Indian_Ocean_Maldives.jpg",
  "Southern Ocean": "https://upload.wikimedia.org/wikipedia/commons/thumb/9/9a/Southern_Ocean_-_iceberg.jpg/512px-Southern_Ocean_-_iceberg.jpg",
  "Arctic Ocean": "https://upload.wikimedia.org/wikipedia/commons/thumb/7/79/Arctic_Ocean_ice.jpg/512px-Arctic_Ocean_ice.jpg"
};

function fmt(num, unit){
  return `${num.toLocaleString('en-US',{maximumFractionDigits: (unit==='km' ? 0 : 2)})} ${unit}`;
}

function setFlagOrPhoto(meta){
  // country flag
  if (meta.iso2){
    const iso = meta.iso2.toLowerCase();
    els.flag.src = `https://flagcdn.com/w80/${iso}.png`;
    els.flag.alt = `${meta.country} flag`;
    return;
  }
  // ocean photo fallback
  const name = meta.ocean || "Pacific Ocean";
  els.flag.src = OCEAN_IMG[name] || OCEAN_IMG["Pacific Ocean"];
  els.flag.alt = name;
}

async function getJSON(url, timeoutMs=7000){
  const ac = new AbortController();
  const t = setTimeout(()=>ac.abort(), timeoutMs);
  try{
    const r = await fetch(url, {signal: ac.signal, headers: {'user-agent':'iss-overlay'}});
    if(!r.ok) throw new Error(r.status);
    return await r.json();
  }finally{ clearTimeout(t) }
}

async function fetchData(){
  // 1) ISS
  const iss = await getJSON(`${API}/iss`);
  const lat = iss.lat, lon = iss.lon;
  // 2) Reverse geocode
  const rg  = await getJSON(`${API}/rg?lat=${lat}&lon=${lon}`);

  // place title (centered)
  const title = rg.ocean ? rg.ocean : (rg.region ? `${rg.region}, ${rg.country}` : rg.country);
  els.place.textContent = title || "—";

  // image
  setFlagOrPhoto({iso2: rg.iso2 || null, country: rg.country, ocean: rg.ocean || null});

  // stat lines
  const now = new Date();
  els.utc.textContent   = now.toISOString().slice(11,19) + " UTC";
  els.date.textContent  = now.toISOString().slice(0,10);
  els.speed.textContent = fmt(iss.speed_kps, "km/s");
  els.alt.textContent   = fmt(iss.alt_km,  "km");
}

// initial + refresh
fetchData().catch(console.error);
setInterval(()=>fetchData().catch(console.error), 12000); // refresh every 12s
</script>
</body>
</html>
