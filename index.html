<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ISS Info Widget</title>
<link rel="preconnect" href="https://iss-live.charlesleahy.workers.dev">
<link rel="preconnect" href="https://flagcdn.com" crossorigin>
<style>
  :root{
    --bg:#0c1117; --panel:#0f1621; --ink:#e9eef7; --muted:#a6b0bf; --accent:#e53935;
    --card:#0d151f; --edge:#101a27; --ink-soft:#c7d0df;
    --w:560px; /* whole widget width */
  }
  html,body{background:#fff; margin:0; font-family: ui-sans-serif, system-ui, "Segoe UI",
    Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";}
  .wrap{ width:var(--w); color:var(--ink); padding:10px 14px; background:transparent;}
  .shell{ background: radial-gradient(120% 120% at 0% 0%, #0a0f16 0%, #0a1117 65%, #070b10 100%);
          border-radius:16px; box-shadow: 0 14px 40px rgba(7,11,16,.35); padding:14px; }
  .title{ background:linear-gradient(180deg,#0f1824,#0c131c);
          border:1px solid #0d1826; border-radius:12px; padding:16px 18px; font-weight:700;
          font-size:28px; line-height:1.15; letter-spacing:.3px; }
  .row{ display:grid; grid-template-columns:118px 1fr; gap:14px; margin-top:10px; }
  .flagCol{ position:relative; display:flex; flex-direction:column; align-items:center; gap:8px; }
  .flagBox{ width:108px; height:72px; border-radius:8px; overflow:hidden; display:grid;
            place-items:center; background:transparent; border:none; }
  .flagBox img, .flagBox svg{ width:100%; height:100%; object-fit:cover; display:block; }
  .live{ user-select:none; font-weight:800; font-size:14px; letter-spacing:.5px;
         color:#fff; padding:8px 14px; border-radius:8px;
         background:linear-gradient(180deg,#ff5a4d,#d72722);
         box-shadow:0 4px 10px rgba(214,45,40,.4), inset 0 0 0 1px rgba(255,255,255,.06); }
  .panel{ background:linear-gradient(180deg,var(--panel),#0b131d);
          border:1px solid var(--edge); border-radius:12px; padding:16px 18px; }
  .grid{ display:grid; grid-template-columns:150px 1fr; row-gap:10px; column-gap:8px; }
  .k{ color:var(--ink-soft); text-align:right; padding-right:8px; }
  .v{ color:var(--ink); font-weight:700; }
  .subtitle{ font-size:20px; font-weight:900; letter-spacing:.2px; margin:0 0 10px 0; }

  /* quick fade slide */
  .fade-enter{ opacity:0; transform: translateY(4px); }
  .fade-enter-active{ opacity:1; transform:none; transition:all .35s ease; }
  .muted{ color:var(--muted); font-variant-numeric: tabular-nums; }

  /* small */
  @media (max-width:640px){
    :root{ --w:520px }
    .title{ font-size:26px }
    .grid{ grid-template-columns:140px 1fr }
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="shell" id="widget">
      <div id="title" class="title">—</div>

      <div class="row">
        <div class="flagCol">
          <div class="flagBox" id="flagBox">
            <!-- filled by JS with <img> or inline ocean svg -->
          </div>
          <div class="live">LIVE</div>
        </div>

        <div class="panel" id="infoPanel">
          <div id="panelInner">
            <!-- filled by JS -->
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const BACKEND = 'https://iss-live.charlesleahy.workers.dev';

  const $ = s => document.querySelector(s);
  const titleEl   = $('#title');
  const flagBox   = $('#flagBox');
  const panel     = $('#infoPanel');
  const inner     = $('#panelInner');

  let lastIso = null, slides = [], slideIdx = 0, slideTimer = null;

  const fmt = {
    km(n){ return Number(n).toLocaleString('en-US'); },
    kps(n){ return (Math.round(Number(n)*100)/100).toFixed(2); },
    km0(n){ return Math.round(Number(n)); },
    date(d){ return d.toISOString().slice(0,10); },
    utc(d){ return d.toISOString().slice(11,19) + ' UTC'; }
  };

  function setFlag({iso2,ocean}) {
    flagBox.innerHTML = '';
    if (ocean) {
      // inline little wave icon (no border)
      flagBox.innerHTML = `
        <svg viewBox="0 0 48 32" xmlns="http://www.w3.org/2000/svg">
          <defs><linearGradient id="g" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0" stop-color="#3fb9ff"/><stop offset="1" stop-color="#1d7bd6"/></linearGradient></defs>
          <rect x="0" y="0" width="48" height="32" fill="#0b2236"/>
          <path d="M4 18c4 0 4-4 8-4s4 4 8 4 4-4 8-4 4 4 8 4 4-4 8-4v6c-4 0-4 4-8 4s-4-4-8-4-4 4-8 4-4-4-8-4-4 4-8 4z" fill="url(#g)"/>
        </svg>`;
      return;
    }
    if (!iso2) return;
    const lower = iso2.toLowerCase();
    const img = new Image();
    img.alt = 'Flag';
    img.referrerPolicy = 'no-referrer';
    img.decoding = 'async';
    img.src = `https://flagcdn.com/w160/${lower}.png`;
    flagBox.appendChild(img);
  }

  function buildSlides(loc, facts, timeNow) {
    const d = new Date(timeNow);
    const stat = {
      'UTC :'  : fmt.utc(d),
      'Date :' : fmt.date(d),
      'Speed :' : `${fmt.kps(loc.speed_kps)} km/s`,
      'Elev :'  : `${fmt.km0(loc.alt_km)} km`,
    };

    const country = {
      title : 'Country Information',
      rows  : [
        ['Capital :', facts.capital || '—'],
        ['Density :', facts.density || '—'],
        ['Poverty :', facts.poverty || '—'],
      ]
    };

    const life = {
      title : 'Life & Age',
      rows  : [
        ['Life Expectancy :', facts.life || '—'],
        ['Male :',  facts.life_male || '—'],
        ['Female :',facts.life_female || '—'],
        ['Median Age :', facts.median_age || '—']
      ]
    };

    const statEl = gridFromObject(stat);
    const ctryEl = gridFromArray(country);
    const lifeEl = gridFromArray(life);

    // rotate country / life panels; stats go above inside same panel
    slides = [
      fragment(statEl, ctryEl),
      fragment(statEl, lifeEl),
    ];
  }

  function gridFromObject(obj){
    const frag = document.createElement('div');
    frag.className = 'grid';
    for (const [k,v] of Object.entries(obj)){
      frag.insertAdjacentHTML('beforeend',
        `<div class="k">${k}</div><div class="v">${v}</div>`);
    }
    return frag;
  }
  function gridFromArray({title,rows}){
    const frag = document.createElement('div');
    frag.innerHTML = `<div class="subtitle">${title}</div>`;
    const g = document.createElement('div');
    g.className = 'grid';
    rows.forEach(([k,v])=>{
      g.insertAdjacentHTML('beforeend', `<div class="k">${k}</div><div class="v">${v}</div>`);
    });
    frag.appendChild(g);
    return frag;
  }
  function fragment(...els){
    const frag = document.createElement('div');
    frag.className = 'fade-enter';
    els.forEach(e=>frag.appendChild(e));
    requestAnimationFrame(()=>frag.classList.add('fade-enter-active'));
    return frag;
  }

  function showSlide(i=0){
    slideIdx = i % slides.length;
    inner.innerHTML = '';
    inner.appendChild(slides[slideIdx]);
  }

  function startRotate(){
    if (slideTimer) clearInterval(slideTimer);
    slideTimer = setInterval(()=> showSlide(slideIdx+1), 10000);
  }

  async function getJSON(url, timeoutMs=7000){
    const ctl = new AbortController();
    const t = setTimeout(()=>ctl.abort(), timeoutMs);
    const r = await fetch(url, {signal:ctl.signal, headers:{'user-agent':'iss-overlay'}})
    .catch(()=>({ok:false}));
    clearTimeout(t);
    if (!r || !r.ok) throw new Error('fetch failed');
    return r.json();
  }

  async function fetchLife(iso2){
    // World Bank – if CORS blocks or data missing, return empty fields.
    const code = (iso2||'').toUpperCase();
    const pick = (arr) => {
      try{
        const series = arr?.[1];
        if (!series) return null;
        const first = series.find(x => x.value!=null);
        return first ? Number(first.value).toFixed(1)+' yrs' : null;
      }catch{return null}
    };
    try{
      const [tot, male, fem] = await Promise.all([
        getJSON(`https://api.worldbank.org/v2/country/${code}/indicator/SP.DYN.LE00.IN?format=json`),
        getJSON(`https://api.worldbank.org/v2/country/${code}/indicator/SP.DYN.LE00.MA.IN?format=json`),
        getJSON(`https://api.worldbank.org/v2/country/${code}/indicator/SP.DYN.LE00.FE.IN?format=json`)
      ]);
      return {
        life: pick(tot) || '—',
        life_male: pick(male) || '—',
        life_female: pick(fem) || '—',
        // Median age is harder to source universally; leave blank unless we add it to the worker later.
        median_age:'—'
      };
    }catch{
      return {life:'—', life_male:'—', life_female:'—', median_age:'—'};
    }
  }

  async function tick(){
    try{
      const iss = await getJSON(`${BACKEND}/iss`);
      const rg  = await getJSON(`${BACKEND}/rg?lat=${iss.lat}&lon=${iss.lon}`);

      const label = rg.ocean ? rg.ocean : [rg.region, rg.country].filter(Boolean).join(', ');
      titleEl.textContent = label || '—';

      const iso2 = rg.iso2 || null;
      setFlag({iso2, ocean: rg.ocean});

      // base facts from your Worker
      let facts = {};
      if (iso2){
        try{
          const f = await getJSON(`${BACKEND}/facts?iso2=${iso2}`);
          facts = {...f};
        }catch{ /* ignore */ }
      }

      // augment with life expectancy when in-country
      if (!rg.ocean && iso2){
        const life = await fetchLife(iso2);
        facts = {...facts, ...life};
      }

      // build slide set and start rotation
      buildSlides(iss, facts, Date.now());
      showSlide(0);
      startRotate();

    }catch(e){
      titleEl.textContent = '—';
      inner.innerHTML = `<div class="muted">Unable to load data.</div>`;
    }
  }

  tick();
  // refresh core data every ~30s
  setInterval(tick, 30000);
})();
</script>
</body>
</html>
