<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ISS Info Widget</title>
<script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>
<!-- satellite.js is optional; we’ll still show data without it -->
<script src="https://cdn.jsdelivr.net/npm/satellite.js@5.0.1/dist/satellite.min.js"></script>
<style>
  :root{ --w:440px; --h:240px; --bg:#0e0f12; --panel:#171a1f; --muted:#9aa4b2; --text:#e7edf5; --card:#101319; }
  html,body{height:100%;margin:0;background:transparent}
  *{box-sizing:border-box;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .widget{width:var(--w);height:var(--h);display:grid;grid-template-rows:1fr 84px;gap:8px;padding:8px;background:var(--bg);color:var(--text);border:1px solid #262a34;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.45);overflow:hidden}
  .location{display:grid;place-items:center;grid-template-rows:auto auto;row-gap:2px;background:linear-gradient(180deg,#12151c,#0e1116);border-radius:10px;border:1px solid #1e2530;padding:10px}
  .locLine{font-weight:700;letter-spacing:.3px;text-align:center;line-height:1.05}
  .locTop{font-size:30px}.locBottom{font-size:26px;opacity:.95}
  .location.small .locTop{font-size:26px}.location.small .locBottom{font-size:22px}
  .location.tiny .locTop{font-size:22px}.location.tiny .locBottom{font-size:19px}
  .bottom{display:grid;grid-template-columns:112px 1fr;gap:8px}
  .flagCard{background:var(--card);border:1px solid #1f2430;border-radius:10px;display:grid;grid-template-rows:1fr 24px;overflow:hidden}
  .flagWrap{display:flex;align-items:center;justify-content:center;padding:8px;background:radial-gradient(120% 140% at 50% 0%,#1a2230 0%,#0f141d 60%,#0b0e13 100%)}
  .flag{width:100%;height:100%;max-width:88px;max-height:60px;object-fit:cover;border-radius:6px;border:1px solid #2a3140;background:#0b0d10}
  .live{background:#c61717;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:900;letter-spacing:.6px;text-transform:uppercase;font-size:12px}
  .info{background:var(--panel);border:1px solid #222937;border-radius:10px;padding:8px 10px;display:grid;grid-template-rows:auto 1fr;gap:6px}
  .rowTitle{font-weight:800;color:#cfd7e3;font-size:16px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:4px 14px;font-size:13px;line-height:1.3;align-content:start}
  .muted{color:var(--muted)} .mono{font-variant-numeric:tabular-nums;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .span2{grid-column:1 / -1;text-align:center}
  #dbg{display:block;margin-top:2px;font-size:10px;color:#9aa4b2;opacity:.85} /* set display:none to hide */
</style>
</head>
<body>
<div class="widget">
  <div class="location" id="loc">
    <div id="locTop" class="locLine locTop">—</div>
    <div id="locBottom" class="locLine locBottom">—</div>
  </div>

  <div class="bottom">
    <div class="flagCard">
      <div class="flagWrap"><img id="flag" class="flag" alt="Flag"/></div>
      <div class="live">LIVE</div>
    </div>

    <div class="info">
      <div class="rowTitle" id="eventTitle">Next: —</div>
      <div class="grid">
        <div><span class="muted">UTC:</span>   <span class="mono" id="utc">—</span></div>
        <div><span class="muted">Date:</span>  <span class="mono" id="date">—</span></div>
        <div><span class="muted">Speed:</span> <span class="mono" id="speed">—</span></div>
        <div><span class="muted">Elev:</span>  <span class="mono" id="alt">—</span></div>
        <div><span class="muted">Density:</span> <span class="mono" id="density">—</span></div>
        <div><span class="muted">Poverty:</span> <span class="mono" id="poverty">—</span></div>
        <div class="span2"><span class="muted">Capital:</span> <span class="mono" id="capital">—</span></div>
      </div>
      <div id="dbg"></div>
    </div>
  </div>
</div>

<script>
/* ------------------ helpers ------------------ */
const el=id=>document.getElementById(id);
const fmt=new Intl.NumberFormat('en-US',{maximumFractionDigits:2});
const fmt3=new Intl.NumberFormat('en-US',{maximumFractionDigits:3});
const pct=x=>(x==null||isNaN(x)?'—':(Math.round(x*10)/10).toFixed(1)+'%');
function fitTwoLine(top,bottom){
  const box=el('loc'); box.classList.remove('small','tiny');
  el('locTop').textContent=top||'—'; el('locBottom').textContent=bottom||'—';
  const total=(top||'').length+(bottom||'').length;
  if(total>26 && total<=40) box.classList.add('small');
  if(total>40) box.classList.add('tiny');
}
async function j(url,timeout=7000){ const c=new AbortController(); const t=setTimeout(()=>c.abort(),timeout); const r=await fetch(url,{signal:c.signal,cache:'no-store'}); clearTimeout(t); if(!r.ok) throw new Error(r.status); return r.json(); }
async function t(url,timeout=7000){ const c=new AbortController(); const tmr=setTimeout(()=>c.abort(),timeout); const r=await fetch(url,{signal:c.signal,cache:'no-store'}); clearTimeout(tmr); if(!r.ok) throw new Error(r.status); return r.text(); }

/* ---------------- local immediate coords (never empty) ---------------- */
function approxISS(){
  // Very small, always-on approximation so we show *something* instantly
  const now=Date.now()/1000;
  const period=92.68*60; // s
  const phase=(now%period)/period*2*Math.PI;
  const inc=51.64*Math.PI/180;
  const lat=Math.asin(Math.sin(inc)*Math.sin(phase))*180/Math.PI;
  const lon=(((phase*57.2958)*1.13)%360)-180; // crude drift -> [-180,180)
  return {lat, lon, altKm:420, speedKps:7.66};
}

/* --------------- better local SGP4 (if satellite.js & TLE available) --------------- */
async function sgp4ISS(){
  try{
    const srcs=[
      "https://r.jina.ai/https://celestrak.org/NORAD/elements/gp.php?CATNR=25544&FORMAT=TLE",
      "https://r.jina.ai/https://celestrak.org/NORAD/elements/stations.txt"
    ];
    let l1,l2,txt=null;
    for(const u of srcs){ try{ txt=await t(u,6000); if(txt) break; }catch{} }
    if(!txt) throw 0;
    const lines=txt.trim().split(/\r?\n/);
    if(lines[0].startsWith('1 25544')){ l1=lines[0].trim(); l2=lines[1].trim(); }
    else{ const i=lines.findIndex(x=>/^ISS \(ZARYA\)/i.test(x)); l1=lines[i+1]?.trim(); l2=lines[i+2]?.trim(); }
    if(!(window.satellite&&l1&&l2)) throw 0;
    const satrec=satellite.twoline2satrec(l1,l2);
    const now=new Date(); const pv=satellite.propagate(satrec,now);
    const gmst=satellite.gstime(now); const gd=satellite.eciToGeodetic(pv.position,gmst);
    const lat=satellite.degreesLat(gd.latitude), lon=satellite.degreesLong(gd.longitude);
    const v=pv.velocity; const speedKps=Math.sqrt(v.x*v.x+v.y*v.y+v.z*v.z);
    return {lat, lon, altKm:gd.height, speedKps};
  }catch{return approxISS();}
}

/* ---------------- remote sources (race) ---------------- */
async function remoteISS(){
  const ts=Date.now();
  const p1=j(`https://api.wheretheiss.at/v1/satellites/25544?ts=${ts}`,6000).then(x=>({lat:x.latitude,lon:x.longitude,altKm:x.altitude,speedKps:x.velocity/3600, src:'WhereTheISS'}));
  const p2=j(`https://cors.isomorphic-git.org/https://api.open-notify.org/iss-now.json`,6000).then(x=>({lat:+x.iss_position.latitude,lon:+x.iss_position.longitude,altKm:undefined,speedKps:undefined, src:'Open-Notify'}));
  return Promise.race([p1,p2]);
}

/* ---------------- reverse geocode chain ---------------- */
async function rg(lat,lon){
  try{ const o=await j(`https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&language=en`,7000); const r=o.results?.[0]; if(r) return {country:r.country, iso:(r.country_code||'').toUpperCase(), region:r.admin1||r.admin2||r.name}; }catch{}
  try{ const o=await j(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`,7000); if(o.countryName) return {country:o.countryName, iso:o.countryCode, region:o.principalSubdivision||o.locality}; }catch{}
  try{ const o=await j(`https://geocode.maps.co/reverse?lat=${lat}&lon=${lon}`,7000); const a=o.address||{}; return {country:a.country, iso:(a.country_code||'').toUpperCase(), region:a.state||a.county||a.region}; }catch{}
  try{ const o=await j(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`,7000); const a=o.address||{}; return {country:a.country, iso:(a.country_code||'').toUpperCase(), region:a.state||a.county||a.region}; }catch{}
  return {country:null,iso:null,region:null};
}

/* ---------------- state + UI ---------------- */
let last={lat:null,lon:null,altKm:null,speedKps:null,iso:null,country:null,region:null};

function updateSun(lat,lon){
  const now=new Date();
  const evts=[]; for(let d=0;d<2;d++){ const day=new Date(now.getTime()+d*86400000); const t=SunCalc.getTimes(day,lat,lon); evts.push({n:'Sunrise',t:t.sunrise},{n:'Sunset',t:t.sunset}); }
  const next=evts.filter(e=>e.t>now).sort((a,b)=>a.t-b.t)[0];
  const pad=n=>String(n).padStart(2,'0'); const d=t=>`${t.getUTCFullYear()}-${pad(t.getUTCMonth()+1)}-${pad(t.getUTCDate())}`; const h=t=>`${pad(t.getUTCHours())}:${pad(t.getUTCMinutes())}:${pad(t.getUTCSeconds())} UTC`;
  if(next){ el('eventTitle').textContent=`Next: ${next.n}`; el('utc').textContent=h(next.t); el('date').textContent=d(next.t); }
}

async function tick(){
  try{
    /* Step 1: show immediate local estimate so UI isn’t empty */
    if(last.lat==null){
      const est = await sgp4ISS().catch(()=>approxISS());
      last.lat=est.lat; last.lon=est.lon; last.altKm=est.altKm; last.speedKps=est.speedKps;
      updateSun(last.lat,last.lon);
      el('speed').textContent=fmt3.format(last.speedKps)+' km/s';
      el('alt').textContent=fmt.format(last.altKm)+' km';
    }

    /* Step 2: race remote call; if it wins, refine numbers */
    remoteISS().then(async (best)=>{
      if(best && isFinite(best.lat) && isFinite(best.lon)){
        last.lat=best.lat; last.lon=best.lon;
        if(isFinite(best.altKm)) last.altKm=best.altKm;
        if(isFinite(best.speedKps)) last.speedKps=best.speedKps;
        updateSun(last.lat,last.lon);
        el('speed').textContent=fmt3.format(last.speedKps)+' km/s';
        el('alt').textContent=fmt.format(last.altKm)+' km';
        el('dbg').textContent=best.src||'local';
        // reverse geocode (only if we don’t already have it or country changed)
        const geo=await rg(last.lat,last.lon);
        last.country=geo.country; last.iso=geo.iso; last.region=geo.region;
        if(last.country&&last.region) fitTwoLine(last.region,last.country);
        else if(last.country) fitTwoLine(last.country,'');
        // flag + facts
        if(last.iso){ const f=el('flag'); f.src=`https://flagcdn.com/w80/${last.iso.toLowerCase()}.png`; f.style.opacity='1'; }
        try{
          if(last.iso){
            const rest=await j(`https://restcountries.com/v3.1/alpha/${last.iso}`,7000); const r=Array.isArray(rest)?rest[0]:rest;
            const population=r?.population, area=r?.area, capital=(r?.capital&&r.capital[0])||'—';
            el('capital').textContent=capital;
            el('density').textContent=(population&&area)?`${fmt.format(population/area)} ppl/km²`:'—';
          }
        }catch{}
        try{
          if(last.iso){
            const wb=await j(`https://api.worldbank.org/v2/country/${last.iso}/indicator/SI.POV.DDAY?format=json&per_page=60`,7000);
            const s=(wb&&wb[1])?wb[1]:[]; const b=s.find(x=>x.value!==null);
            el('poverty').textContent = (b && typeof b.value==='number')? pct(b.value) : '—';
          }
        }catch{}
      }
    });

    /* Step 3: if we already have country from a previous tick, keep it on screen */
    if(last.country){
      if(last.region) fitTwoLine(last.region,last.country); else fitTwoLine(last.country,'');
      if(last.iso){ const f=el('flag'); f.src=`https://flagcdn.com/w80/${last.iso.toLowerCase()}.png`; f.style.opacity='1'; }
    }

  }catch(e){ /* keep last-good data on screen */ }
}

/* live UTC labels */
setInterval(()=>{const n=new Date(),p=v=>String(v).padStart(2,'0'); el('date').textContent=`${n.getUTCFullYear()}-${p(n.getUTCMonth()+1)}-${p(n.getUTCDate())}`; el('utc').textContent=`${p(n.getUTCHours())}:${p(n.getUTCMinutes())}:${p(n.getUTCSeconds())} UTC`;},1000);

/* kick off */
tick();
setInterval(tick, 5000);
</script>
</body>
</html>
