<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ISS Info Widget</title>
<!-- Sunrise/Sunset math -->
<script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>
<!-- Optional: local orbit fallback (we’ll use it only if the web APIs fail) -->
<script src="https://cdn.jsdelivr.net/npm/satellite.js@5.0.1/dist/satellite.min.js"></script>
<style>
  :root{ --w:480px; --h:260px; --bg:#0e0f12; --panel:#171a1f; --muted:#9aa4b2; --text:#e7edf5; --card:#101319; }
  html,body{height:100%;margin:0;background:transparent}
  *{box-sizing:border-box;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}

  .widget{width:var(--w);height:var(--h);display:grid;grid-template-rows:1fr 96px;gap:10px;padding:10px;
          background:var(--bg);color:var(--text);border:1px solid #262a34;border-radius:14px;
          box-shadow:0 8px 24px rgba(0,0,0,.45);overflow:hidden}

  /* Title (one line, auto shrink) */
  .location{display:grid;place-items:center;background:linear-gradient(180deg,#12151c,#0e1116);
            border-radius:12px;border:1px solid #1e2530;padding:14px}
  #title{font-weight:700;letter-spacing:.3px;line-height:1.05;font-size:34px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-align:center}
  .location.small #title{font-size:28px}
  .location.tiny  #title{font-size:22px}

  .bottom{display:grid;grid-template-columns:120px 1fr;gap:10px}

  .flagCard{background:var(--card);border:1px solid #1f2430;border-radius:12px;display:grid;grid-template-rows:1fr 26px;overflow:hidden}
  .flagWrap{display:flex;align-items:center;justify-content:center;padding:10px;background:radial-gradient(120% 140% at 50% 0%,#1a2230 0%,#0f141d 60%,#0b0e13 100%)}
  .flag{width:100%;height:100%;max-width:96px;max-height:64px;object-fit:cover;border-radius:8px;border:1px solid #2a3140;background:#0b0d10}
  .live{background:#b80e0e;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:900;letter-spacing:.6px;text-transform:uppercase;font-size:13px}

  .info{background:var(--panel);border:1px solid #222937;border-radius:12px;padding:10px 12px;display:grid;grid-template-rows:auto 1fr;gap:6px}
  .rowTitle{font-weight:900;color:#cfd7e3;font-size:18px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:6px 18px;font-size:14px;line-height:1.25;align-content:start}
  .muted{color:var(--muted)}
  .mono{font-variant-numeric:tabular-nums;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .span2{grid-column:1/-1}

  /* tap/click to switch info panel */
  .tappable{cursor:pointer;user-select:none}
</style>
</head>
<body>
<div class="widget">
  <div class="location" id="loc"><div id="title">—</div></div>

  <div class="bottom">
    <div class="flagCard">
      <div class="flagWrap"><img id="flag" class="flag" alt="Flag"/></div>
      <div class="live">LIVE NOW</div>
    </div>

    <div class="info tappable" id="info">
      <div class="rowTitle" id="panelTitle">Next: —</div>
      <div class="grid" id="panelNow">
        <div><span class="muted">UTC:</span>   <span class="mono" id="utc">—</span></div>
        <div><span class="muted">Date:</span>  <span class="mono" id="date">—</span></div>
        <div><span class="muted">Speed:</span> <span class="mono" id="speed">—</span></div>
        <div><span class="muted">Elev:</span>  <span class="mono" id="alt">—</span></div>
        <div class="span2"><span class="muted">Coords:</span> <span class="mono" id="coords">—</span></div>
      </div>

      <div class="grid" id="panelFacts" style="display:none">
        <div class="span2"><strong>Country Information</strong></div>
        <div><span class="muted">Life Expectancy:</span> <span class="mono" id="leTotal">—</span></div>
        <div><span class="muted">Median Age:</span> <span class="mono" id="medianAge">—</span></div>
        <div><span class="muted">Male:</span>   <span class="mono" id="leMale">—</span></div>
        <div><span class="muted">Female:</span> <span class="mono" id="leFemale">—</span></div>
        <div><span class="muted">Land Area:</span>   <span class="mono" id="landArea">—</span></div>
        <div><span class="muted">Forest:</span>      <span class="mono" id="forest">—</span></div>
        <div><span class="muted">Pasture:</span>     <span class="mono" id="pasture">—</span></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ========================= CONFIG ========================= */
/* If you later set up the optional Cloudflare Worker I gave you,
   put its URL here to force all calls through it and get max stability.
   Leave empty to call public APIs directly. */
const WORKER_BASE = ""; // e.g., "https://iss-live.YOURNAME.workers.dev"

const REFRESH_MS = 6000;           // how often we update position
const PANEL_SWAP_MS = 12000;       // auto rotate info panels
/* ========================================================== */

const el = id => document.getElementById(id);
const fmt2 = new Intl.NumberFormat('en-US',{maximumFractionDigits:2});
const fmt3 = new Intl.NumberFormat('en-US',{maximumFractionDigits:3});
const pad  = n => String(n).padStart(2,'0');

function setTitle(text){
  const box = el('loc'); box.classList.remove('small','tiny');
  el('title').textContent = text || '—';
  const n = (text||'').length;
  if(n>28 && n<=44) box.classList.add('small');
  if(n>44) box.classList.add('tiny');
}

/* ---------- tiny fetch helpers with timeout ---------- */
async function getText(url, timeout=7000){
  const ctrl = new AbortController(); const t = setTimeout(()=>ctrl.abort(), timeout);
  const r = await fetch(url, { signal: ctrl.signal, cache:'no-store' }).catch(()=>({ok:false}));
  clearTimeout(t); if(!r || !r.ok) throw new Error('fetch '+url); return r.text();
}
async function getJSON(url, timeout=7000){
  return JSON.parse(await getText(url, timeout));
}

/* ---------- ISS position (robust chain, no keys) ---------- */
async function getISS(){
  if(WORKER_BASE){
    const j = await getJSON(`${WORKER_BASE}/iss`);
    return { lat: +j.lat, lon: +j.lon, altKm: j.alt_km ?? null, speedKps: j.speed_kps ?? null };
  }
  // 1) WhereTheISS (fast, CORS OK)
  try{
    const j = await getJSON(`https://api.wheretheiss.at/v1/satellites/25544?ts=${Date.now()}`, 6000);
    return { lat:+j.latitude, lon:+j.longitude, altKm:+j.altitude, speedKps:+j.velocity/3600 };
  }catch(e){}
  // 2) WhereTheISS via text proxy
  try{
    const txt = await getText(`https://r.jina.ai/http://api.wheretheiss.at/v1/satellites/25544`, 7000);
    const j = JSON.parse(txt);
    return { lat:+j.latitude, lon:+j.longitude, altKm:+j.altitude, speedKps:+j.velocity/3600 };
  }catch(e){}
  // 3) Open-Notify via proxy (coords only)
  try{
    const j = await getJSON(`https://cors.isomorphic-git.org/https://api.open-notify.org/iss-now.json`, 6000);
    return { lat:+j.iss_position.latitude, lon:+j.iss_position.longitude, altKm:null, speedKps:null };
  }catch(e){}
  // 4) Local SGP4 (needs TLE)
  try{
    const tle = await getText(`https://r.jina.ai/https://celestrak.org/NORAD/elements/stations.txt`, 7000);
    const lines = tle.split(/\r?\n/); const i = lines.findIndex(s=>/^ISS \(ZARYA\)/i.test(s));
    const l1 = lines[i+1]?.trim(), l2 = lines[i+2]?.trim();
    if(window.satellite && l1 && l2){
      const satrec = satellite.twoline2satrec(l1, l2), now = new Date();
      const pv = satellite.propagate(satrec, now), gmst = satellite.gstime(now);
      const gd = satellite.eciToGeodetic(pv.position, gmst);
      const v  = pv.velocity; const sp = Math.sqrt(v.x*v.x+v.y*v.y+v.z*v.z);
      return { lat: satellite.degreesLat(gd.latitude),
               lon: satellite.degreesLong(gd.longitude),
               altKm: gd.height, speedKps: sp };
    }
  }catch(e){}
  throw new Error('All ISS sources failed');
}

/* ---------- Reverse geocode + ocean detection ---------- */
async function reverseGeocode(lat,lon){
  if(WORKER_BASE){
    const j = await getJSON(`${WORKER_BASE}/rg?lat=${lat}&lon=${lon}`);
    return { country:j.country||null, iso2:j.iso2||null, region:j.region||null, ocean:j.ocean||null };
  }
  try{
    const j = await getJSON(`https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&language=en`,7000);
    const r = j?.results?.[0]; if(r) return { country:r.country||null, iso2:(r.country_code||'').toUpperCase()||null, region:r.admin1||r.admin2||r.name||null, ocean:null };
  }catch(e){}
  try{
    const j = await getJSON(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`,7000);
    const inf = j?.localityInfo?.informative || []; const o = inf.find(x=>/ocean/i.test(x.description||x.name||''));
    if(j.countryName || o) return { country:j.countryName||null, iso2:j.countryCode||null, region:j.principalSubdivision||j.locality||null, ocean:o ? (o.name||o.description) : null };
  }catch(e){}
  try{
    const j = await getJSON(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`,7000);
    const a = j.address||{}; return { country:a.country||null, iso2:(a.country_code||'').toUpperCase()||null, region:a.state||a.county||a.region||null, ocean:a.ocean||a.water||null };
  }catch(e){}
  return { country:null, iso2:null, region:null, ocean:null };
}

/* ---------- Country facts (World Bank + REST Countries) ---------- */
async function countryFacts(iso2){
  const out = { leT:null, leM:null, leF:null, landKm2:null, forestKm2:null, forestPct:null, pastureKm2:null, pasturePct:null, medianAge:null };
  if(WORKER_BASE){
    // Worker gives capital/density/poverty; here we pull extended series client-side.
  }
  try{
    // REST Countries for total area (km²)
    const r = await getJSON(`https://restcountries.com/v3.1/alpha/${iso2}`,7000);
    const rc = Array.isArray(r)?r[0]:r; out.landKm2 = rc?.area || null;
  }catch(e){}
  // World Bank helper
  async function wb(code){
    try{
      const j = await getJSON(`https://api.worldbank.org/v2/country/${iso2}/indicator/${code}?format=json&per_page=70`,8000);
      const s = j?.[1]||[]; const v = s.find(x=>x.value!==null); return (v&&typeof v.value==='number')? v.value : null;
    }catch(e){ return null; }
  }
  out.leT = await wb('SP.DYN.LE00.IN');       // life expectancy, total (years)
  out.leM = await wb('SP.DYN.LE00.MA.IN');    // male
  out.leF = await wb('SP.DYN.LE00.FE.IN');    // female
  const forestKm2  = await wb('AG.LND.FRST.K2'); out.forestKm2 = forestKm2;
  const forestPct  = await wb('AG.LND.FRST.ZS'); out.forestPct = forestPct;
  const pastureKm2 = await wb('AG.LND.PAST.K2'); out.pastureKm2 = pastureKm2;
  const pasturePct = await wb('AG.LND.PAST.ZS'); out.pasturePct = pasturePct;
  // Median age isn’t in WB; leave null (UI will hide if missing)
  return out;
}

/* ---------- Sun event helpers ---------- */
function nextSun(lat,lon){
  const now=new Date(); const list=[];
  for(let d=0; d<2; d++){
    const day = new Date(now.getTime()+d*86400000);
    const t = SunCalc.getTimes(day, lat, lon);
    list.push({name:'Sunrise',t:t.sunrise}, {name:'Sunset',t:t.sunset});
  }
  const next = list.filter(x=>x.t && x.t>now).sort((a,b)=>a.t-b.t)[0];
  if(!next) return null;
  const mins = Math.round((next.t-now)/60000);
  const inTxt = mins<=0? 'now' : (mins<60? `${mins} min` : `${Math.floor(mins/60)} h ${mins%60} m`);
  return { label:`Next: ${next.name} in ${inTxt}`, at: next.t };
}
const toUTCd = d => `${d.getUTCFullYear()}-${pad(d.getUTCMonth()+1)}-${pad(d.getUTCDate())}`;
const toUTCt = d => `${pad(d.getUTCHours())}:${pad(d.getUTCMinutes())}:${pad(d.getUTCSeconds())} UTC`;

/* ---------- UI state ---------- */
let lastPlace=null, lastIso=null, panelIdx=0;
function swapPanel(){
  panelIdx = (panelIdx+1)%2;
  el('panelNow').style.display  = panelIdx===0?'grid':'none';
  el('panelFacts').style.display= panelIdx===1?'grid':'none';
}
el('info').addEventListener('click', swapPanel);
setInterval(swapPanel, PANEL_SWAP_MS);

/* ---------- main loop ---------- */
async function tick(){
  try{
    const pos = await getISS();
    // Coords + numbers
    el('coords').textContent = `${pos.lat.toFixed(2)}° ${pos.lat>=0?'N':'S'}, ${pos.lon.toFixed(2)}° ${pos.lon>=0?'E':'W'}`;
    el('speed').textContent  = pos.speedKps!=null ? `${fmt3.format(pos.speedKps)} km/s` : '—';
    el('alt').textContent    = pos.altKm!=null   ? `${fmt2.format(pos.altKm)} km`     : '—';

    // Next sun event
    const sun = nextSun(pos.lat, pos.lon);
    if(sun){ el('panelTitle').textContent = sun.label; el('utc').textContent = toUTCt(sun.at); el('date').textContent = toUTCd(sun.at); }

    // Place
    const place = await reverseGeocode(pos.lat, pos.lon);
    lastPlace = place;
    if(place.ocean && !place.country){
      setTitle(place.ocean);
    }else{
      const title = (place.region && place.country) ? `${place.region}, ${place.country}` : (place.country || place.region || '—');
      setTitle(title);
    }

    // Flag
    if(place.iso2){ lastIso = place.iso2; const f=el('flag'); f.src=`https://flagcdn.com/w80/${place.iso2.toLowerCase()}.png`; f.style.opacity='1'; }

    // Facts
    if(place.iso2){
      const facts = await countryFacts(place.iso2);
      const orDash = v => (v==null||isNaN(v))?'—':v;
      const yrs = v => (v==null||isNaN(v))?'—':`${fmt2.format(v)} yrs`;

      el('leTotal').textContent = yrs(facts.leT);
      el('leMale').textContent  = yrs(facts.leM);
      el('leFemale').textContent= yrs(facts.leF);

      el('medianAge').textContent = '—'; // (left blank; no consistent free source with CORS)

      const land = facts.landKm2!=null ? Math.round(facts.landKm2).toLocaleString('en-US')+' km²' : '—';
      el('landArea').textContent = land;

      const forestK = facts.forestKm2!=null ? Math.round(facts.forestKm2).toLocaleString('en-US')+' km²' : '—';
      const forestP = facts.forestPct!=null ? ` (${fmt2.format(facts.forestPct)}%)` : '';
      el('forest').textContent = (forestK==='—' && !forestP)?'—':`${forestK}${forestP}`;

      const pastureK = facts.pastureKm2!=null ? Math.round(facts.pastureKm2).toLocaleString('en-US')+' km²' : '—';
      const pastureP = facts.pasturePct!=null ? ` (${fmt2.format(facts.pasturePct)}%)` : '';
      el('pasture').textContent = (pastureK==='—' && !pastureP)?'—':`${pastureK}${pastureP}`;
    }
  }catch(err){
    // Leave last good values up; nothing else to do
    // console.error(err);
  }
}

/* live UTC clock (for the “UTC:” line even before first sun calc) */
setInterval(()=>{const n=new Date(); el('date').textContent=toUTCd(n); el('utc').textContent=toUTCt(n);},1000);

tick();
setInterval(tick, REFRESH_MS);
</script>
</body>
</html>
